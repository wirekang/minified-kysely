import{f as e,I as t,S as i,C as s,i as n,V as r,p as o,a,b as p,c,R as d,d as h,n as l,O as u,e as m,Q as y,g as w,h as f,j as g,k as v,W as N,D as b,l as x,m as C,o as T,q as E,r as _,s as O,t as I,u as k,v as S,w as M,x as D,P as A,y as L,z as P,A as W,B as q,E as Q,F as R,G as B,H as U,J as $,K as F,L as V,M as j,N as J,T as K,U as z,X as G,Y,Z as H,_ as X,$ as Z,a0 as ee,a1 as te}from"./sql-A2tQZs4J.js";export{b9 as ARITHMETIC_OPERATORS,am as AggregateFunctionBuilder,aG as AggregateFunctionNode,aH as AliasNode,an as AliasedAggregateFunctionBuilder,aE as AliasedDynamicTableBuilder,a6 as AliasedExpressionWrapper,at as AliasedJSONPathBuilder,aI as AndNode,a8 as AndWrapper,bb as BINARY_OPERATORS,b8 as COMPARISON_OPERATORS,aq as CaseEndBuilder,ao as CaseThenBuilder,ap as CaseWhenBuilder,aJ as CollateNode,aK as ColumnUpdateNode,aL as CommonTableExpressionNameNode,aM as CommonTableExpressionNode,aO as DefaultInsertValueNode,ac as DeleteQueryBuilder,aP as DeleteQueryNode,ah as DeleteResult,aQ as ExplainNode,a5 as ExpressionWrapper,aR as FetchNode,aS as FromNode,aT as FunctionNode,aU as GroupByItemNode,aV as GroupByNode,aW as HavingNode,aa as InsertQueryBuilder,ag as InsertResult,aY as JSONOperatorChainNode,ar as JSONPathBuilder,aZ as JSONPathLegNode,a_ as JSONPathNode,a$ as JSONReferenceNode,ba as JSON_OPERATORS,af as JoinBuilder,aX as JoinNode,b0 as LimitNode,b1 as ListNode,b2 as MatchedNode,aw as MatchedThenableMergeQueryBuilder,au as MergeQueryBuilder,b3 as MergeQueryNode,ay as MergeResult,aC as NOOP_QUERY_EXECUTOR,ad as NoResultError,aB as NoopQueryExecutor,ax as NotMatchedThenableMergeQueryBuilder,be as OPERATORS,b4 as OffsetNode,aj as OnConflictBuilder,ak as OnConflictDoNothingBuilder,b5 as OnConflictNode,al as OnConflictUpdateBuilder,b6 as OnDuplicateKeyNode,b7 as OnNode,bk as OrActionNode,bl as OrNode,a7 as OrWrapper,az as OrderByItemBuilder,bm as OrderByItemNode,bn as OrderByNode,bo as OutputNode,bp as OverNode,bq as PartitionByItemNode,br as PartitionByNode,bs as ReferenceNode,bt as ReturningNode,bu as SelectModifierNode,bv as SelectionNode,bw as TableNode,bx as TopNode,as as TraversedJSONPathBuilder,by as TupleNode,bc as UNARY_FILTER_OPERATORS,bd as UNARY_OPERATORS,bz as UnaryOperationNode,ab as UpdateQueryBuilder,bA as UpdateQueryNode,ai as UpdateResult,bB as UsingNode,bC as ValuesNode,av as WheneableMergeQueryBuilder,bD as WhereNode,bE as WithNode,aA as createRawBuilder,a9 as createSelectQueryBuilder,a2 as expressionBuilder,aF as isAliasedDynamicTableBuilder,a4 as isAliasedExpression,bi as isArithmeticOperator,bg as isBinaryOperator,aN as isColumnDataType,bh as isComparisonOperator,aD as isDynamicReferenceBuilder,a3 as isExpression,bj as isJSONOperator,ae as isNoResultErrorConstructor,bf as isOperator}from"./sql-A2tQZs4J.js";const ie=e({is:e=>"AlterTableNode"===e.kind,create:t=>e({kind:"AlterTableNode",table:t}),cloneWithTableProps:(t,i)=>e({...t,...i}),cloneWithColumnAlteration:(t,i)=>e({...t,columnAlterations:t.columnAlterations?[...t.columnAlterations,i]:[i]})}),se=e({is:e=>"CreateIndexNode"===e.kind,create:i=>e({kind:"CreateIndexNode",name:t.create(i)}),cloneWith:(t,i)=>e({...t,...i}),cloneWithColumns:(t,i)=>e({...t,columns:[...t.columns||[],...i]})}),ne=e({is:e=>"CreateSchemaNode"===e.kind,create:(i,s)=>e({kind:"CreateSchemaNode",schema:t.create(i),...s}),cloneWith:(t,i)=>e({...t,...i})}),re=["preserve rows","delete rows","drop"],oe=e({is:e=>"CreateTableNode"===e.kind,create:t=>e({kind:"CreateTableNode",table:t,columns:e([])}),cloneWithColumn:(t,i)=>e({...t,columns:e([...t.columns,i])}),cloneWithConstraint:(t,i)=>e({...t,constraints:t.constraints?e([...t.constraints,i]):e([i])}),cloneWithFrontModifier:(t,i)=>e({...t,frontModifiers:t.frontModifiers?e([...t.frontModifiers,i]):e([i])}),cloneWithEndModifier:(t,i)=>e({...t,endModifiers:t.endModifiers?e([...t.endModifiers,i]):e([i])}),cloneWith:(t,i)=>e({...t,...i})}),pe=e({is:e=>"DropIndexNode"===e.kind,create:(t,s)=>e({kind:"DropIndexNode",name:i.create(t),...s}),cloneWith:(t,i)=>e({...t,...i})}),ce=e({is:e=>"DropSchemaNode"===e.kind,create:(i,s)=>e({kind:"DropSchemaNode",schema:t.create(i),...s}),cloneWith:(t,i)=>e({...t,...i})}),de=e({is:e=>"DropTableNode"===e.kind,create:(t,i)=>e({kind:"DropTableNode",table:t,...i}),cloneWith:(t,i)=>e({...t,...i})}),he=e({is:e=>"AddColumnNode"===e.kind,create:t=>e({kind:"AddColumnNode",column:t})}),le=e({is:e=>"ColumnDefinitionNode"===e.kind,create:(t,i)=>e({kind:"ColumnDefinitionNode",column:s.create(t),dataType:i}),cloneWithFrontModifier:(t,i)=>e({...t,frontModifiers:t.frontModifiers?e([...t.frontModifiers,i]):[i]}),cloneWithEndModifier:(t,i)=>e({...t,endModifiers:t.endModifiers?e([...t.endModifiers,i]):[i]}),cloneWith:(t,i)=>e({...t,...i})}),ue=e({is:e=>"DropColumnNode"===e.kind,create:t=>e({kind:"DropColumnNode",column:s.create(t)})}),me=e({is:e=>"RenameColumnNode"===e.kind,create:(t,i)=>e({kind:"RenameColumnNode",column:s.create(t),renameTo:s.create(i)})}),ye=e({is:e=>"CheckConstraintNode"===e.kind,create:(i,s)=>e({kind:"CheckConstraintNode",expression:i,name:s?t.create(s):void 0})}),we=["no action","restrict","cascade","set null","set default"],fe=e({is:e=>"ReferencesNode"===e.kind,create:(t,i)=>e({kind:"ReferencesNode",table:t,columns:e([...i])}),cloneWithOnDelete:(t,i)=>e({...t,onDelete:i}),cloneWithOnUpdate:(t,i)=>e({...t,onUpdate:i})});function ge(e){return n(e)?e.toOperationNode():r.createImmediate(e)}const ve=e({is:e=>"GeneratedNode"===e.kind,create:t=>e({kind:"GeneratedNode",...t}),createWithExpression:t=>e({kind:"GeneratedNode",always:!0,expression:t}),cloneWith:(t,i)=>e({...t,...i})}),Ne=e({is:e=>"DefaultValueNode"===e.kind,create:t=>e({kind:"DefaultValueNode",defaultValue:t})});function xe(e){if(we.includes(e))return e;throw new Error(`invalid OnModifyForeignAction ${e}`)}class Ce{#e;constructor(e){this.#e=e}autoIncrement(){return new Ce(le.cloneWith(this.#e,{autoIncrement:!0}))}identity(){return new Ce(le.cloneWith(this.#e,{identity:!0}))}primaryKey(){return new Ce(le.cloneWith(this.#e,{primaryKey:!0}))}references(e){const t=o(e);if(!t.table||a.is(t.column))throw new Error(`invalid call references('${e}'). The reference must have format table.column or schema.table.column`);return new Ce(le.cloneWith(this.#e,{references:fe.create(t.table,[t.column])}))}onDelete(e){if(!this.#e.references)throw new Error("on delete constraint can only be added for foreign keys");return new Ce(le.cloneWith(this.#e,{references:fe.cloneWithOnDelete(this.#e.references,xe(e))}))}onUpdate(e){if(!this.#e.references)throw new Error("on update constraint can only be added for foreign keys");return new Ce(le.cloneWith(this.#e,{references:fe.cloneWithOnUpdate(this.#e.references,xe(e))}))}unique(){return new Ce(le.cloneWith(this.#e,{unique:!0}))}notNull(){return new Ce(le.cloneWith(this.#e,{notNull:!0}))}unsigned(){return new Ce(le.cloneWith(this.#e,{unsigned:!0}))}defaultTo(e){return new Ce(le.cloneWith(this.#e,{defaultTo:Ne.create(ge(e))}))}check(e){return new Ce(le.cloneWith(this.#e,{check:ye.create(e.toOperationNode())}))}generatedAlwaysAs(e){return new Ce(le.cloneWith(this.#e,{generated:ve.createWithExpression(e.toOperationNode())}))}generatedAlwaysAsIdentity(){return new Ce(le.cloneWith(this.#e,{generated:ve.create({identity:!0,always:!0})}))}generatedByDefaultAsIdentity(){return new Ce(le.cloneWith(this.#e,{generated:ve.create({identity:!0,byDefault:!0})}))}stored(){if(!this.#e.generated)throw new Error("stored() can only be called after generatedAlwaysAs");return new Ce(le.cloneWith(this.#e,{generated:ve.cloneWith(this.#e.generated,{stored:!0})}))}modifyFront(e){return new Ce(le.cloneWithFrontModifier(this.#e,e.toOperationNode()))}nullsNotDistinct(){return new Ce(le.cloneWith(this.#e,{nullsNotDistinct:!0}))}ifNotExists(){return new Ce(le.cloneWith(this.#e,{ifNotExists:!0}))}modifyEnd(e){return new Ce(le.cloneWithEndModifier(this.#e,e.toOperationNode()))}$call(e){return e(this)}toOperationNode(){return this.#e}}const Te=e({is:e=>"ModifyColumnNode"===e.kind,create:t=>e({kind:"ModifyColumnNode",column:t})}),Ee=e({is:e=>"ForeignKeyConstraintNode"===e.kind,create:(i,s,n,r)=>e({kind:"ForeignKeyConstraintNode",columns:i,references:fe.create(s,n),name:r?t.create(r):void 0}),cloneWith:(t,i)=>e({...t,...i})});class _e{#e;constructor(e){this.#e=e}onDelete(e){return new _e(Ee.cloneWith(this.#e,{onDelete:xe(e)}))}onUpdate(e){return new _e(Ee.cloneWith(this.#e,{onUpdate:xe(e)}))}deferrable(){return new _e(Ee.cloneWith(this.#e,{deferrable:!0}))}notDeferrable(){return new _e(Ee.cloneWith(this.#e,{deferrable:!1}))}initiallyDeferred(){return new _e(Ee.cloneWith(this.#e,{initiallyDeferred:!0}))}initiallyImmediate(){return new _e(Ee.cloneWith(this.#e,{initiallyDeferred:!1}))}$call(e){return e(this)}toOperationNode(){return this.#e}}const Oe=e({is:e=>"AddConstraintNode"===e.kind,create:t=>e({kind:"AddConstraintNode",constraint:t})}),Ie=e({is:e=>"UniqueConstraintNode"===e.kind,create:(i,n,r)=>e({kind:"UniqueConstraintNode",columns:e(i.map(s.create)),name:n?t.create(n):void 0,nullsNotDistinct:r}),cloneWith:(t,i)=>e({...t,...i})}),ke=e({is:e=>"DropConstraintNode"===e.kind,create:i=>e({kind:"DropConstraintNode",constraintName:t.create(i)}),cloneWith:(t,i)=>e({...t,...i})}),Se=e({is:e=>"AlterColumnNode"===e.kind,create:(t,i,n)=>e({kind:"AlterColumnNode",column:s.create(t),[i]:n})});class Me{#t;constructor(e){this.#t=e}setDataType(e){return new De(Se.create(this.#t,"dataType",p(e)))}setDefault(e){return new De(Se.create(this.#t,"setDefault",ge(e)))}dropDefault(){return new De(Se.create(this.#t,"dropDefault",!0))}setNotNull(){return new De(Se.create(this.#t,"setNotNull",!0))}dropNotNull(){return new De(Se.create(this.#t,"dropNotNull",!0))}$call(e){return e(this)}}class De{#i;constructor(e){this.#i=e}toOperationNode(){return this.#i}}class Ae{#s;constructor(t){this.#s=e(t)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}class Le{#s;constructor(t){this.#s=e(t)}onDelete(e){return new Le({...this.#s,constraintBuilder:this.#s.constraintBuilder.onDelete(e)})}onUpdate(e){return new Le({...this.#s,constraintBuilder:this.#s.constraintBuilder.onUpdate(e)})}deferrable(){return new Le({...this.#s,constraintBuilder:this.#s.constraintBuilder.deferrable()})}notDeferrable(){return new Le({...this.#s,constraintBuilder:this.#s.constraintBuilder.notDeferrable()})}initiallyDeferred(){return new Le({...this.#s,constraintBuilder:this.#s.constraintBuilder.initiallyDeferred()})}initiallyImmediate(){return new Le({...this.#s,constraintBuilder:this.#s.constraintBuilder.initiallyImmediate()})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(ie.cloneWithTableProps(this.#s.node,{addConstraint:Oe.create(this.#s.constraintBuilder.toOperationNode())}),this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}class Pe{#s;constructor(t){this.#s=e(t)}ifExists(){return new Pe({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{dropConstraint:ke.cloneWith(this.#s.node.dropConstraint,{ifExists:!0})})})}cascade(){return new Pe({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{dropConstraint:ke.cloneWith(this.#s.node.dropConstraint,{modifier:"cascade"})})})}restrict(){return new Pe({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{dropConstraint:ke.cloneWith(this.#s.node.dropConstraint,{modifier:"restrict"})})})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}const We=e({is:e=>"PrimaryKeyConstraintNode"===e.kind,create:(i,n)=>e({kind:"PrimaryKeyConstraintNode",columns:e(i.map(s.create)),name:n?t.create(n):void 0}),cloneWith:(t,i)=>e({...t,...i})}),qe=We,Qe=e({is:e=>"AddIndexNode"===e.kind,create:i=>e({kind:"AddIndexNode",name:t.create(i)}),cloneWith:(t,i)=>e({...t,...i}),cloneWithColumns:(t,i)=>e({...t,columns:[...t.columns||[],...i]})});class Re{#s;constructor(t){this.#s=e(t)}unique(){return new Re({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{addIndex:Qe.cloneWith(this.#s.node.addIndex,{unique:!0})})})}column(e){return new Re({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{addIndex:Qe.cloneWithColumns(this.#s.node.addIndex,[c(e)])})})}columns(e){return new Re({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{addIndex:Qe.cloneWithColumns(this.#s.node.addIndex,e.map(c))})})}expression(e){return new Re({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{addIndex:Qe.cloneWithColumns(this.#s.node.addIndex,[e.toOperationNode()])})})}using(e){return new Re({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{addIndex:Qe.cloneWith(this.#s.node.addIndex,{using:d.createWithSql(e)})})})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}class Be{#e;constructor(e){this.#e=e}nullsNotDistinct(){return new Be(Ie.cloneWith(this.#e,{nullsNotDistinct:!0}))}deferrable(){return new Be(Ie.cloneWith(this.#e,{deferrable:!0}))}notDeferrable(){return new Be(Ie.cloneWith(this.#e,{deferrable:!1}))}initiallyDeferred(){return new Be(Ie.cloneWith(this.#e,{initiallyDeferred:!0}))}initiallyImmediate(){return new Be(Ie.cloneWith(this.#e,{initiallyDeferred:!1}))}$call(e){return e(this)}toOperationNode(){return this.#e}}class Ue{#e;constructor(e){this.#e=e}deferrable(){return new Ue(We.cloneWith(this.#e,{deferrable:!0}))}notDeferrable(){return new Ue(We.cloneWith(this.#e,{deferrable:!1}))}initiallyDeferred(){return new Ue(We.cloneWith(this.#e,{initiallyDeferred:!0}))}initiallyImmediate(){return new Ue(We.cloneWith(this.#e,{initiallyDeferred:!1}))}$call(e){return e(this)}toOperationNode(){return this.#e}}class $e{#e;constructor(e){this.#e=e}$call(e){return e(this)}toOperationNode(){return this.#e}}const Fe=e({is:e=>"RenameConstraintNode"===e.kind,create:(i,s)=>e({kind:"RenameConstraintNode",oldName:t.create(i),newName:t.create(s)})});class Ve{#s;constructor(t){this.#s=e(t)}renameTo(e){return new Ae({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{renameTo:h(e)})})}setSchema(e){return new Ae({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{setSchema:t.create(e)})})}alterColumn(e,t){const i=t(new Me(e));return new je({...this.#s,node:ie.cloneWithColumnAlteration(this.#s.node,i.toOperationNode())})}dropColumn(e){return new je({...this.#s,node:ie.cloneWithColumnAlteration(this.#s.node,ue.create(e))})}renameColumn(e,t){return new je({...this.#s,node:ie.cloneWithColumnAlteration(this.#s.node,me.create(e,t))})}addColumn(e,t,i=l){const s=i(new Ce(le.create(e,p(t))));return new je({...this.#s,node:ie.cloneWithColumnAlteration(this.#s.node,he.create(s.toOperationNode()))})}modifyColumn(e,t,i=l){const s=i(new Ce(le.create(e,p(t))));return new je({...this.#s,node:ie.cloneWithColumnAlteration(this.#s.node,Te.create(s.toOperationNode()))})}addUniqueConstraint(e,t,i=l){const s=i(new Be(Ie.create(t,e)));return new Ae({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{addConstraint:Oe.create(s.toOperationNode())})})}addCheckConstraint(e,t,i=l){const s=i(new $e(ye.create(t.toOperationNode(),e)));return new Ae({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{addConstraint:Oe.create(s.toOperationNode())})})}addForeignKeyConstraint(e,t,i,n,r=l){const o=r(new _e(Ee.create(t.map(s.create),h(i),n.map(s.create),e)));return new Le({...this.#s,constraintBuilder:o})}addPrimaryKeyConstraint(e,t,i=l){const s=i(new Ue(We.create(t,e)));return new Ae({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{addConstraint:Oe.create(s.toOperationNode())})})}dropConstraint(e){return new Pe({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{dropConstraint:ke.create(e)})})}renameConstraint(e,t){return new Pe({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{renameConstraint:Fe.create(e,t)})})}addIndex(e){return new Re({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{addIndex:Qe.create(e)})})}dropIndex(e){return new Ae({...this.#s,node:ie.cloneWithTableProps(this.#s.node,{dropIndex:pe.create(e)})})}$call(e){return e(this)}}class je{#s;constructor(t){this.#s=e(t)}alterColumn(e,t){const i=t(new Me(e));return new je({...this.#s,node:ie.cloneWithColumnAlteration(this.#s.node,i.toOperationNode())})}dropColumn(e){return new je({...this.#s,node:ie.cloneWithColumnAlteration(this.#s.node,ue.create(e))})}renameColumn(e,t){return new je({...this.#s,node:ie.cloneWithColumnAlteration(this.#s.node,me.create(e,t))})}addColumn(e,t,i=l){const s=i(new Ce(le.create(e,p(t))));return new je({...this.#s,node:ie.cloneWithColumnAlteration(this.#s.node,he.create(s.toOperationNode()))})}modifyColumn(e,t,i=l){const s=i(new Ce(le.create(e,p(t))));return new je({...this.#s,node:ie.cloneWithColumnAlteration(this.#s.node,Te.create(s.toOperationNode()))})}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}class Je extends u{transformPrimitiveValueList(e){return m.create(e.values.map(r.createImmediate))}transformValue(e){return r.createImmediate(e.value)}}class Ke{#s;constructor(t){this.#s=e(t)}ifNotExists(){return new Ke({...this.#s,node:se.cloneWith(this.#s.node,{ifNotExists:!0})})}unique(){return new Ke({...this.#s,node:se.cloneWith(this.#s.node,{unique:!0})})}nullsNotDistinct(){return new Ke({...this.#s,node:se.cloneWith(this.#s.node,{nullsNotDistinct:!0})})}on(e){return new Ke({...this.#s,node:se.cloneWith(this.#s.node,{table:h(e)})})}column(e){return new Ke({...this.#s,node:se.cloneWithColumns(this.#s.node,[c(e)])})}columns(e){return new Ke({...this.#s,node:se.cloneWithColumns(this.#s.node,e.map(c))})}expression(e){return new Ke({...this.#s,node:se.cloneWithColumns(this.#s.node,[e.toOperationNode()])})}using(e){return new Ke({...this.#s,node:se.cloneWith(this.#s.node,{using:d.createWithSql(e)})})}where(...e){const t=new Je;return new Ke({...this.#s,node:y.cloneWithWhere(this.#s.node,t.transformNode(w(e),this.#s.queryId))})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}class ze{#s;constructor(t){this.#s=e(t)}ifNotExists(){return new ze({...this.#s,node:ne.cloneWith(this.#s.node,{ifNotExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}function Ge(e){if(re.includes(e))return e;throw new Error(`invalid OnCommitAction ${e}`)}class Ye{#s;constructor(t){this.#s=e(t)}temporary(){return new Ye({...this.#s,node:oe.cloneWith(this.#s.node,{temporary:!0})})}onCommit(e){return new Ye({...this.#s,node:oe.cloneWith(this.#s.node,{onCommit:Ge(e)})})}ifNotExists(){return new Ye({...this.#s,node:oe.cloneWith(this.#s.node,{ifNotExists:!0})})}addColumn(e,t,i=l){const s=i(new Ce(le.create(e,p(t))));return new Ye({...this.#s,node:oe.cloneWithColumn(this.#s.node,s.toOperationNode())})}addPrimaryKeyConstraint(e,t,i=l){const s=i(new Ue(We.create(t,e)));return new Ye({...this.#s,node:oe.cloneWithConstraint(this.#s.node,s.toOperationNode())})}addUniqueConstraint(e,t,i=l){const s=i(new Be(Ie.create(t,e)));return new Ye({...this.#s,node:oe.cloneWithConstraint(this.#s.node,s.toOperationNode())})}addCheckConstraint(e,t,i=l){const s=i(new $e(ye.create(t.toOperationNode(),e)));return new Ye({...this.#s,node:oe.cloneWithConstraint(this.#s.node,s.toOperationNode())})}addForeignKeyConstraint(e,t,i,n,r=l){const o=r(new _e(Ee.create(t.map(s.create),h(i),n.map(s.create),e)));return new Ye({...this.#s,node:oe.cloneWithConstraint(this.#s.node,o.toOperationNode())})}modifyFront(e){return new Ye({...this.#s,node:oe.cloneWithFrontModifier(this.#s.node,e.toOperationNode())})}modifyEnd(e){return new Ye({...this.#s,node:oe.cloneWithEndModifier(this.#s.node,e.toOperationNode())})}as(e){return new Ye({...this.#s,node:oe.cloneWith(this.#s.node,{selectQuery:f(e)})})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}class He{#s;constructor(t){this.#s=e(t)}on(e){return new He({...this.#s,node:pe.cloneWith(this.#s.node,{table:h(e)})})}ifExists(){return new He({...this.#s,node:pe.cloneWith(this.#s.node,{ifExists:!0})})}cascade(){return new He({...this.#s,node:pe.cloneWith(this.#s.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}class Xe{#s;constructor(t){this.#s=e(t)}ifExists(){return new Xe({...this.#s,node:ce.cloneWith(this.#s.node,{ifExists:!0})})}cascade(){return new Xe({...this.#s,node:ce.cloneWith(this.#s.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}class Ze{#s;constructor(t){this.#s=e(t)}ifExists(){return new Ze({...this.#s,node:de.cloneWith(this.#s.node,{ifExists:!0})})}cascade(){return new Ze({...this.#s,node:de.cloneWith(this.#s.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}const et=e({is:e=>"CreateViewNode"===e.kind,create:t=>e({kind:"CreateViewNode",name:i.create(t)}),cloneWith:(t,i)=>e({...t,...i})});class tt{#n=new Je;transformQuery(e){return this.#n.transformNode(e.node,e.queryId)}transformResult(e){return Promise.resolve(e.result)}}class it{#s;constructor(t){this.#s=e(t)}temporary(){return new it({...this.#s,node:et.cloneWith(this.#s.node,{temporary:!0})})}materialized(){return new it({...this.#s,node:et.cloneWith(this.#s.node,{materialized:!0})})}ifNotExists(){return new it({...this.#s,node:et.cloneWith(this.#s.node,{ifNotExists:!0})})}orReplace(){return new it({...this.#s,node:et.cloneWith(this.#s.node,{orReplace:!0})})}columns(e){return new it({...this.#s,node:et.cloneWith(this.#s.node,{columns:e.map(g)})})}as(e){const t=e.withPlugin(new tt).toOperationNode();return new it({...this.#s,node:et.cloneWith(this.#s.node,{as:t})})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}const st=e({is:e=>"DropViewNode"===e.kind,create:t=>e({kind:"DropViewNode",name:i.create(t)}),cloneWith:(t,i)=>e({...t,...i})});class nt{#s;constructor(t){this.#s=e(t)}materialized(){return new nt({...this.#s,node:st.cloneWith(this.#s.node,{materialized:!0})})}ifExists(){return new nt({...this.#s,node:st.cloneWith(this.#s.node,{ifExists:!0})})}cascade(){return new nt({...this.#s,node:st.cloneWith(this.#s.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}const rt=e({is:e=>"CreateTypeNode"===e.kind,create:t=>e({kind:"CreateTypeNode",name:t}),cloneWithEnum:(t,i)=>e({...t,enum:m.create(i.map(r.createImmediate))})});class ot{#s;constructor(t){this.#s=e(t)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}asEnum(e){return new ot({...this.#s,node:rt.cloneWithEnum(this.#s.node,e)})}$call(e){return e(this)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}const pt=e({is:e=>"DropTypeNode"===e.kind,create:t=>e({kind:"DropTypeNode",name:t}),cloneWith:(t,i)=>e({...t,...i})});class ct{#s;constructor(t){this.#s=e(t)}ifExists(){return new ct({...this.#s,node:pt.cloneWith(this.#s.node,{ifExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}function dt(e){if(e.includes(".")){const t=e.split(".").map(ht);if(2===t.length)return i.createWithSchema(t[0],t[1]);throw new Error(`invalid schemable identifier ${e}`)}return i.create(e)}function ht(e){return e.trim()}const lt=e({is:e=>"RefreshMaterializedViewNode"===e.kind,create:t=>e({kind:"RefreshMaterializedViewNode",name:i.create(t)}),cloneWith:(t,i)=>e({...t,...i})});class ut{#s;constructor(t){this.#s=e(t)}concurrently(){return new ut({...this.#s,node:lt.cloneWith(this.#s.node,{concurrently:!0,withNoData:!1})})}withData(){return new ut({...this.#s,node:lt.cloneWith(this.#s.node,{withNoData:!1})})}withNoData(){return new ut({...this.#s,node:lt.cloneWith(this.#s.node,{withNoData:!0,concurrently:!1})})}$call(e){return e(this)}toOperationNode(){return this.#s.executor.transformQuery(this.#s.node,this.#s.queryId)}compile(){return this.#s.executor.compileQuery(this.toOperationNode(),this.#s.queryId)}async execute(){await this.#s.executor.executeQuery(this.compile())}}class mt{#r;constructor(e){this.#r=e}createTable(e){return new Ye({queryId:v(),executor:this.#r,node:oe.create(h(e))})}dropTable(e){return new Ze({queryId:v(),executor:this.#r,node:de.create(h(e))})}createIndex(e){return new Ke({queryId:v(),executor:this.#r,node:se.create(e)})}dropIndex(e){return new He({queryId:v(),executor:this.#r,node:pe.create(e)})}createSchema(e){return new ze({queryId:v(),executor:this.#r,node:ne.create(e)})}dropSchema(e){return new Xe({queryId:v(),executor:this.#r,node:ce.create(e)})}alterTable(e){return new Ve({queryId:v(),executor:this.#r,node:ie.create(h(e))})}createView(e){return new it({queryId:v(),executor:this.#r,node:et.create(e)})}refreshMaterializedView(e){return new ut({queryId:v(),executor:this.#r,node:lt.create(e)})}dropView(e){return new nt({queryId:v(),executor:this.#r,node:st.create(e)})}createType(e){return new ot({queryId:v(),executor:this.#r,node:rt.create(dt(e))})}dropType(e){return new ct({queryId:v(),executor:this.#r,node:pt.create(dt(e))})}withPlugin(e){return new mt(this.#r.withPlugin(e))}withoutPlugins(){return new mt(this.#r.withoutPlugins())}withSchema(e){return new mt(this.#r.withPluginAtFront(new N(e)))}}class yt{ref(e){return new b(e)}table(e){return new x(e)}}class wt{#o;constructor(e){this.#o=e}async provideConnection(e){const t=await this.#o.acquireConnection();try{return await e(t)}finally{await this.#o.releaseConnection(t)}}}class ft extends C{#a;#p;#c;constructor(e,t,i,s=[]){super(s),this.#a=e,this.#p=t,this.#c=i}get adapter(){return this.#p}compileQuery(e,t){return this.#a.compileQuery(e,t)}provideConnection(e){return this.#c.provideConnection(e)}withPlugins(e){return new ft(this.#a,this.#p,this.#c,[...this.plugins,...e])}withPlugin(e){return new ft(this.#a,this.#p,this.#c,[...this.plugins,e])}withPluginAtFront(e){return new ft(this.#a,this.#p,this.#c,[e,...this.plugins])}withConnectionProvider(e){return new ft(this.#a,this.#p,e,[...this.plugins])}withoutPlugins(){return new ft(this.#a,this.#p,this.#c,[])}}function gt(){return"undefined"!=typeof performance&&T(performance.now)?performance.now():Date.now()}class vt{#o;#d;#h;#l;#u;#m=new WeakSet;constructor(e,t){this.#l=!1,this.#o=e,this.#d=t}async init(){if(this.#u)throw new Error("driver has already been destroyed");this.#h||(this.#h=this.#o.init().then((()=>{this.#l=!0})).catch((e=>(this.#h=void 0,Promise.reject(e))))),await this.#h}async acquireConnection(){if(this.#u)throw new Error("driver has already been destroyed");this.#l||await this.init();const e=await this.#o.acquireConnection();return this.#m.has(e)||(this.#y()&&this.#w(e),this.#m.add(e)),e}async releaseConnection(e){await this.#o.releaseConnection(e)}beginTransaction(e,t){return this.#o.beginTransaction(e,t)}commitTransaction(e){return this.#o.commitTransaction(e)}rollbackTransaction(e){return this.#o.rollbackTransaction(e)}savepoint(e,t,i){if(this.#o.savepoint)return this.#o.savepoint(e,t,i);throw new Error("The `savepoint` method is not supported by this driver")}rollbackToSavepoint(e,t,i){if(this.#o.rollbackToSavepoint)return this.#o.rollbackToSavepoint(e,t,i);throw new Error("The `rollbackToSavepoint` method is not supported by this driver")}releaseSavepoint(e,t,i){if(this.#o.releaseSavepoint)return this.#o.releaseSavepoint(e,t,i);throw new Error("The `releaseSavepoint` method is not supported by this driver")}async destroy(){this.#h&&(await this.#h,this.#u||(this.#u=this.#o.destroy().catch((e=>(this.#u=void 0,Promise.reject(e))))),await this.#u)}#y(){return this.#d.isLevelEnabled("query")||this.#d.isLevelEnabled("error")}#w(e){const t=e.executeQuery,i=e.streamQuery,s=this;e.executeQuery=async i=>{let n;const r=gt();try{return await t.call(e,i)}catch(e){throw n=e,await s.#f(e,i,r),e}finally{n||await s.#g(i,r)}},e.streamQuery=async function*(t,n){let r;const o=gt();try{for await(const s of i.call(e,t,n))yield s}catch(e){throw r=e,await s.#f(e,t,o),e}finally{r||await s.#g(t,o,!0)}}}async#f(e,t,i){await this.#d.error((()=>({level:"error",error:e,query:t,queryDurationMillis:this.#v(i)})))}async#g(e,t,i=!1){await this.#d.query((()=>({level:"query",isStream:i,query:e,queryDurationMillis:this.#v(t)})))}#v(e){return gt()-e}}const Nt=()=>{};class xt{#N;#b;constructor(e){this.#N=e}async provideConnection(e){for(;this.#b;)await this.#b.catch(Nt);return this.#b=this.#x(e).finally((()=>{this.#b=void 0})),this.#b}async#x(e){return await e(this.#N)}}const Ct=["read only","read write"],Tt=["read uncommitted","read committed","repeatable read","serializable","snapshot"];function Et(e){if(e.accessMode&&!Ct.includes(e.accessMode))throw new Error(`invalid transaction access mode ${e.accessMode}`);if(e.isolationLevel&&!Tt.includes(e.isolationLevel))throw new Error(`invalid transaction isolation level ${e.isolationLevel}`)}const _t=e(["query","error"]);class Ot{#C;#T;constructor(t){T(t)?(this.#T=t,this.#C=e({query:!0,error:!0})):(this.#T=It,this.#C=e({query:t.includes("query"),error:t.includes("error")}))}isLevelEnabled(e){return this.#C[e]}async query(e){this.#C.query&&await this.#T(e())}async error(e){this.#C.error&&await this.#T(e())}}function It(e){if("query"===e.level){const t="kysely:query:"+(e.isStream?"stream:":"");console.log(`${t} ${e.query.sql}`),console.log(`${t} duration: ${e.queryDurationMillis.toFixed(1)}ms`)}else"error"===e.level&&(e.error instanceof Error?console.error(`kysely:error: ${e.error.stack??e.error.message}`):console.error(`kysely:error: ${JSON.stringify({error:e.error,query:e.query.sql,queryDurationMillis:e.queryDurationMillis})}`))}function kt(e){return E(e)&&T(e.compile)}Symbol.asyncDispose??=Symbol("Symbol.asyncDispose");class St extends _{#s;constructor(t){let i,s;if(Dt(t))i={executor:t.executor},s={...t};else{const e=t.dialect,n=e.createDriver(),r=e.createQueryCompiler(),o=e.createAdapter(),a=new Ot(t.log??[]),p=new vt(n,a),c=new wt(p),d=new ft(r,o,c,t.plugins??[]);i={executor:d},s={config:t,executor:d,dialect:e,driver:p}}super(i),this.#s=e(s)}get schema(){return new mt(this.#s.executor)}get dynamic(){return new yt}get introspection(){return this.#s.dialect.createIntrospector(this.withoutPlugins())}case(e){return new O({node:I.create(k(e)?void 0:f(e))})}get fn(){return S()}transaction(){return new Lt({...this.#s})}startTransaction(){return new Pt({...this.#s})}connection(){return new At({...this.#s})}withPlugin(e){return new St({...this.#s,executor:this.#s.executor.withPlugin(e)})}withoutPlugins(){return new St({...this.#s,executor:this.#s.executor.withoutPlugins()})}withSchema(e){return new St({...this.#s,executor:this.#s.executor.withPluginAtFront(new N(e))})}withTables(){return new St({...this.#s})}async destroy(){await this.#s.driver.destroy()}get isTransaction(){return!1}getExecutor(){return this.#s.executor}executeQuery(e,t){void 0!==t&&M("Passing `queryId` in `db.executeQuery` is deprecated and will result in a compile-time error in the future.");const i=kt(e)?e.compile():e;return this.getExecutor().executeQuery(i)}async[Symbol.asyncDispose](){await this.destroy()}}class Mt extends St{#s;constructor(e){super(e),this.#s=e}get isTransaction(){return!0}transaction(){throw new Error("calling the transaction method for a Transaction is not supported")}connection(){throw new Error("calling the connection method for a Transaction is not supported")}async destroy(){throw new Error("calling the destroy method for a Transaction is not supported")}withPlugin(e){return new Mt({...this.#s,executor:this.#s.executor.withPlugin(e)})}withoutPlugins(){return new Mt({...this.#s,executor:this.#s.executor.withoutPlugins()})}withSchema(e){return new Mt({...this.#s,executor:this.#s.executor.withPluginAtFront(new N(e))})}withTables(){return new Mt({...this.#s})}}function Dt(e){return E(e)&&E(e.config)&&E(e.driver)&&E(e.executor)&&E(e.dialect)}class At{#s;constructor(t){this.#s=e(t)}async execute(e){return this.#s.executor.provideConnection((async t=>{const i=this.#s.executor.withConnectionProvider(new xt(t)),s=new St({...this.#s,executor:i});return await e(s)}))}}class Lt{#s;constructor(t){this.#s=e(t)}setAccessMode(e){return new Lt({...this.#s,accessMode:e})}setIsolationLevel(e){return new Lt({...this.#s,isolationLevel:e})}async execute(e){const{isolationLevel:t,accessMode:i,...s}=this.#s,n={isolationLevel:t,accessMode:i};return Et(n),this.#s.executor.provideConnection((async t=>{const i=this.#s.executor.withConnectionProvider(new xt(t)),r=new Mt({...s,executor:i});let o=!1;try{await this.#s.driver.beginTransaction(t,n),o=!0;const i=await e(r);return await this.#s.driver.commitTransaction(t),i}catch(e){throw o&&await this.#s.driver.rollbackTransaction(t),e}}))}}class Pt{#s;constructor(t){this.#s=e(t)}setAccessMode(e){return new Pt({...this.#s,accessMode:e})}setIsolationLevel(e){return new Pt({...this.#s,isolationLevel:e})}async execute(){const{isolationLevel:e,accessMode:t,...i}=this.#s,s={isolationLevel:e,accessMode:t};Et(s);const n=await D(this.#s.executor);return await this.#s.driver.beginTransaction(n.connection,s),new Wt({...i,connection:n,executor:this.#s.executor.withConnectionProvider(new xt(n.connection))})}}class Wt extends Mt{#s;#E;#_;constructor(t){const i={isCommitted:!1,isRolledBack:!1};t={...t,executor:new Rt(t.executor,i)};const{connection:s,...n}=t;super(n),this.#s=e(t),this.#_=i;const r=v();this.#E=e=>t.executor.compileQuery(e,r)}get isCommitted(){return this.#_.isCommitted}get isRolledBack(){return this.#_.isRolledBack}commit(){return Qt(this.#_),new qt((async()=>{await this.#s.driver.commitTransaction(this.#s.connection.connection),this.#_.isCommitted=!0,this.#s.connection.release()}))}rollback(){return Qt(this.#_),new qt((async()=>{await this.#s.driver.rollbackTransaction(this.#s.connection.connection),this.#_.isRolledBack=!0,this.#s.connection.release()}))}savepoint(e){return Qt(this.#_),new qt((async()=>(await(this.#s.driver.savepoint?.(this.#s.connection.connection,e,this.#E)),new Wt({...this.#s}))))}rollbackToSavepoint(e){return Qt(this.#_),new qt((async()=>(await(this.#s.driver.rollbackToSavepoint?.(this.#s.connection.connection,e,this.#E)),new Wt({...this.#s}))))}releaseSavepoint(e){return Qt(this.#_),new qt((async()=>(await(this.#s.driver.releaseSavepoint?.(this.#s.connection.connection,e,this.#E)),new Wt({...this.#s}))))}withPlugin(e){return new Wt({...this.#s,executor:this.#s.executor.withPlugin(e)})}withoutPlugins(){return new Wt({...this.#s,executor:this.#s.executor.withoutPlugins()})}withSchema(e){return new Wt({...this.#s,executor:this.#s.executor.withPluginAtFront(new N(e))})}withTables(){return new Wt({...this.#s})}}class qt{#O;constructor(e){this.#O=e}async execute(){return await this.#O()}}function Qt(e){if(e.isCommitted)throw new Error("Transaction is already committed");if(e.isRolledBack)throw new Error("Transaction is already rolled back")}class Rt{#r;#_;constructor(e,t){this.#r=e instanceof Rt?e.#r:e,this.#_=t}get adapter(){return this.#r.adapter}get plugins(){return this.#r.plugins}transformQuery(e,t){return this.#r.transformQuery(e,t)}compileQuery(e,t){return this.#r.compileQuery(e,t)}provideConnection(e){return this.#r.provideConnection(e)}executeQuery(e){return Qt(this.#_),this.#r.executeQuery(e)}stream(e,t){return Qt(this.#_),this.#r.stream(e,t)}withConnectionProvider(e){return new Rt(this.#r.withConnectionProvider(e),this.#_)}withPlugin(e){return new Rt(this.#r.withPlugin(e),this.#_)}withPlugins(e){return new Rt(this.#r.withPlugins(e),this.#_)}withPluginAtFront(e){return new Rt(this.#r.withPluginAtFront(e),this.#_)}withoutPlugins(){return new Rt(this.#r.withoutPlugins(),this.#_)}}class Bt{nodeStack=[];get parentNode(){return this.nodeStack[this.nodeStack.length-2]}#I=e({AliasNode:this.visitAlias.bind(this),ColumnNode:this.visitColumn.bind(this),IdentifierNode:this.visitIdentifier.bind(this),SchemableIdentifierNode:this.visitSchemableIdentifier.bind(this),RawNode:this.visitRaw.bind(this),ReferenceNode:this.visitReference.bind(this),SelectQueryNode:this.visitSelectQuery.bind(this),SelectionNode:this.visitSelection.bind(this),TableNode:this.visitTable.bind(this),FromNode:this.visitFrom.bind(this),SelectAllNode:this.visitSelectAll.bind(this),AndNode:this.visitAnd.bind(this),OrNode:this.visitOr.bind(this),ValueNode:this.visitValue.bind(this),ValueListNode:this.visitValueList.bind(this),PrimitiveValueListNode:this.visitPrimitiveValueList.bind(this),ParensNode:this.visitParens.bind(this),JoinNode:this.visitJoin.bind(this),OperatorNode:this.visitOperator.bind(this),WhereNode:this.visitWhere.bind(this),InsertQueryNode:this.visitInsertQuery.bind(this),DeleteQueryNode:this.visitDeleteQuery.bind(this),ReturningNode:this.visitReturning.bind(this),CreateTableNode:this.visitCreateTable.bind(this),AddColumnNode:this.visitAddColumn.bind(this),ColumnDefinitionNode:this.visitColumnDefinition.bind(this),DropTableNode:this.visitDropTable.bind(this),DataTypeNode:this.visitDataType.bind(this),OrderByNode:this.visitOrderBy.bind(this),OrderByItemNode:this.visitOrderByItem.bind(this),GroupByNode:this.visitGroupBy.bind(this),GroupByItemNode:this.visitGroupByItem.bind(this),UpdateQueryNode:this.visitUpdateQuery.bind(this),ColumnUpdateNode:this.visitColumnUpdate.bind(this),LimitNode:this.visitLimit.bind(this),OffsetNode:this.visitOffset.bind(this),OnConflictNode:this.visitOnConflict.bind(this),OnDuplicateKeyNode:this.visitOnDuplicateKey.bind(this),CreateIndexNode:this.visitCreateIndex.bind(this),DropIndexNode:this.visitDropIndex.bind(this),ListNode:this.visitList.bind(this),PrimaryKeyConstraintNode:this.visitPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.visitUniqueConstraint.bind(this),ReferencesNode:this.visitReferences.bind(this),CheckConstraintNode:this.visitCheckConstraint.bind(this),WithNode:this.visitWith.bind(this),CommonTableExpressionNode:this.visitCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.visitCommonTableExpressionName.bind(this),HavingNode:this.visitHaving.bind(this),CreateSchemaNode:this.visitCreateSchema.bind(this),DropSchemaNode:this.visitDropSchema.bind(this),AlterTableNode:this.visitAlterTable.bind(this),DropColumnNode:this.visitDropColumn.bind(this),RenameColumnNode:this.visitRenameColumn.bind(this),AlterColumnNode:this.visitAlterColumn.bind(this),ModifyColumnNode:this.visitModifyColumn.bind(this),AddConstraintNode:this.visitAddConstraint.bind(this),DropConstraintNode:this.visitDropConstraint.bind(this),RenameConstraintNode:this.visitRenameConstraint.bind(this),ForeignKeyConstraintNode:this.visitForeignKeyConstraint.bind(this),CreateViewNode:this.visitCreateView.bind(this),RefreshMaterializedViewNode:this.visitRefreshMaterializedView.bind(this),DropViewNode:this.visitDropView.bind(this),GeneratedNode:this.visitGenerated.bind(this),DefaultValueNode:this.visitDefaultValue.bind(this),OnNode:this.visitOn.bind(this),ValuesNode:this.visitValues.bind(this),SelectModifierNode:this.visitSelectModifier.bind(this),CreateTypeNode:this.visitCreateType.bind(this),DropTypeNode:this.visitDropType.bind(this),ExplainNode:this.visitExplain.bind(this),DefaultInsertValueNode:this.visitDefaultInsertValue.bind(this),AggregateFunctionNode:this.visitAggregateFunction.bind(this),OverNode:this.visitOver.bind(this),PartitionByNode:this.visitPartitionBy.bind(this),PartitionByItemNode:this.visitPartitionByItem.bind(this),SetOperationNode:this.visitSetOperation.bind(this),BinaryOperationNode:this.visitBinaryOperation.bind(this),UnaryOperationNode:this.visitUnaryOperation.bind(this),UsingNode:this.visitUsing.bind(this),FunctionNode:this.visitFunction.bind(this),CaseNode:this.visitCase.bind(this),WhenNode:this.visitWhen.bind(this),JSONReferenceNode:this.visitJSONReference.bind(this),JSONPathNode:this.visitJSONPath.bind(this),JSONPathLegNode:this.visitJSONPathLeg.bind(this),JSONOperatorChainNode:this.visitJSONOperatorChain.bind(this),TupleNode:this.visitTuple.bind(this),MergeQueryNode:this.visitMergeQuery.bind(this),MatchedNode:this.visitMatched.bind(this),AddIndexNode:this.visitAddIndex.bind(this),CastNode:this.visitCast.bind(this),FetchNode:this.visitFetch.bind(this),TopNode:this.visitTop.bind(this),OutputNode:this.visitOutput.bind(this),OrActionNode:this.visitOrAction.bind(this),CollateNode:this.visitCollate.bind(this)});visitNode=e=>{this.nodeStack.push(e),this.#I[e.kind](e),this.nodeStack.pop()}}const Ut=/'/g;class $t extends Bt{#k="";#S=[];get numParameters(){return this.#S.length}compileQuery(t,i){return this.#k="",this.#S=[],this.nodeStack.splice(0,this.nodeStack.length),this.visitNode(t),e({query:t,queryId:i,sql:this.getSql(),parameters:[...this.#S]})}getSql(){return this.#k}visitSelectQuery(e){const t=!(void 0===this.parentNode||A.is(this.parentNode)||L.is(this.parentNode)||oe.is(this.parentNode)||et.is(this.parentNode)||P.is(this.parentNode));void 0===this.parentNode&&e.explain&&(this.visitNode(e.explain),this.append(" ")),t&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("select"),e.distinctOn&&(this.append(" "),this.compileDistinctOn(e.distinctOn)),e.frontModifiers?.length&&(this.append(" "),this.compileList(e.frontModifiers," ")),e.top&&(this.append(" "),this.visitNode(e.top)),e.selections&&(this.append(" "),this.compileList(e.selections)),e.from&&(this.append(" "),this.visitNode(e.from)),e.joins&&(this.append(" "),this.compileList(e.joins," ")),e.where&&(this.append(" "),this.visitNode(e.where)),e.groupBy&&(this.append(" "),this.visitNode(e.groupBy)),e.having&&(this.append(" "),this.visitNode(e.having)),e.setOperations&&(this.append(" "),this.compileList(e.setOperations," ")),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.offset&&(this.append(" "),this.visitNode(e.offset)),e.fetch&&(this.append(" "),this.visitNode(e.fetch)),e.endModifiers?.length&&(this.append(" "),this.compileList(this.sortSelectModifiers([...e.endModifiers])," ")),t&&this.append(")")}visitFrom(e){this.append("from "),this.compileList(e.froms)}visitSelection(e){this.visitNode(e.selection)}visitColumn(e){this.visitNode(e.column)}compileDistinctOn(e){this.append("distinct on ("),this.compileList(e),this.append(")")}compileList(e,t=", "){const i=e.length-1;for(let s=0;s<=i;s++)this.visitNode(e[s]),s<i&&this.append(t)}visitWhere(e){this.append("where "),this.visitNode(e.where)}visitHaving(e){this.append("having "),this.visitNode(e.having)}visitInsertQuery(e){const t=void 0!==this.parentNode&&!A.is(this.parentNode)&&!d.is(this.parentNode)&&!W.is(this.parentNode);void 0===this.parentNode&&e.explain&&(this.visitNode(e.explain),this.append(" ")),t&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append(e.replace?"replace":"insert"),e.ignore&&(M("`InsertQueryNode.ignore` is deprecated. Use `InsertQueryNode.orAction` instead."),this.append(" ignore")),e.orAction&&(this.append(" "),this.visitNode(e.orAction)),e.top&&(this.append(" "),this.visitNode(e.top)),e.into&&(this.append(" into "),this.visitNode(e.into)),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.output&&(this.append(" "),this.visitNode(e.output)),e.values&&(this.append(" "),this.visitNode(e.values)),e.defaultValues&&(this.append(" "),this.append("default values")),e.onConflict&&(this.append(" "),this.visitNode(e.onConflict)),e.onDuplicateKey&&(this.append(" "),this.visitNode(e.onDuplicateKey)),e.returning&&(this.append(" "),this.visitNode(e.returning)),t&&this.append(")"),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitValues(e){this.append("values "),this.compileList(e.values)}visitDeleteQuery(e){const t=void 0!==this.parentNode&&!A.is(this.parentNode)&&!d.is(this.parentNode);void 0===this.parentNode&&e.explain&&(this.visitNode(e.explain),this.append(" ")),t&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("delete "),e.top&&(this.visitNode(e.top),this.append(" ")),this.visitNode(e.from),e.output&&(this.append(" "),this.visitNode(e.output)),e.using&&(this.append(" "),this.visitNode(e.using)),e.joins&&(this.append(" "),this.compileList(e.joins," ")),e.where&&(this.append(" "),this.visitNode(e.where)),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.returning&&(this.append(" "),this.visitNode(e.returning)),t&&this.append(")"),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitReturning(e){this.append("returning "),this.compileList(e.selections)}visitAlias(e){this.visitNode(e.node),this.append(" as "),this.visitNode(e.alias)}visitReference(e){e.table&&(this.visitNode(e.table),this.append(".")),this.visitNode(e.column)}visitSelectAll(e){this.append("*")}visitIdentifier(e){this.append(this.getLeftIdentifierWrapper()),this.compileUnwrappedIdentifier(e),this.append(this.getRightIdentifierWrapper())}compileUnwrappedIdentifier(e){if(!q(e.name))throw new Error("a non-string identifier was passed to compileUnwrappedIdentifier.");this.append(this.sanitizeIdentifier(e.name))}visitAnd(e){this.visitNode(e.left),this.append(" and "),this.visitNode(e.right)}visitOr(e){this.visitNode(e.left),this.append(" or "),this.visitNode(e.right)}visitValue(e){e.immediate?this.appendImmediateValue(e.value):this.appendValue(e.value)}visitValueList(e){this.append("("),this.compileList(e.values),this.append(")")}visitTuple(e){this.append("("),this.compileList(e.values),this.append(")")}visitPrimitiveValueList(e){this.append("(");const{values:t}=e;for(let e=0;e<t.length;++e)this.appendValue(t[e]),e!==t.length-1&&this.append(", ");this.append(")")}visitParens(e){this.append("("),this.visitNode(e.node),this.append(")")}visitJoin(e){this.append(jt[e.joinType]),this.append(" "),this.visitNode(e.table),e.on&&(this.append(" "),this.visitNode(e.on))}visitOn(e){this.append("on "),this.visitNode(e.on)}visitRaw(e){const{sqlFragments:t,parameters:i}=e;for(let e=0;e<t.length;++e)this.append(t[e]),i.length>e&&this.visitNode(i[e])}visitOperator(e){this.append(e.operator)}visitTable(e){this.visitNode(e.table)}visitSchemableIdentifier(e){e.schema&&(this.visitNode(e.schema),this.append(".")),this.visitNode(e.identifier)}visitCreateTable(e){this.append("create "),e.frontModifiers&&e.frontModifiers.length>0&&(this.compileList(e.frontModifiers," "),this.append(" ")),e.temporary&&this.append("temporary "),this.append("table "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.table),e.selectQuery?(this.append(" as "),this.visitNode(e.selectQuery)):(this.append(" ("),this.compileList([...e.columns,...e.constraints??[]]),this.append(")"),e.onCommit&&(this.append(" on commit "),this.append(e.onCommit)),e.endModifiers&&e.endModifiers.length>0&&(this.append(" "),this.compileList(e.endModifiers," ")))}visitColumnDefinition(e){e.ifNotExists&&this.append("if not exists "),this.visitNode(e.column),this.append(" "),this.visitNode(e.dataType),e.unsigned&&this.append(" unsigned"),e.frontModifiers&&e.frontModifiers.length>0&&(this.append(" "),this.compileList(e.frontModifiers," ")),e.generated&&(this.append(" "),this.visitNode(e.generated)),e.identity&&this.append(" identity"),e.defaultTo&&(this.append(" "),this.visitNode(e.defaultTo)),e.notNull&&this.append(" not null"),e.unique&&this.append(" unique"),e.nullsNotDistinct&&this.append(" nulls not distinct"),e.primaryKey&&this.append(" primary key"),e.autoIncrement&&(this.append(" "),this.append(this.getAutoIncrement())),e.references&&(this.append(" "),this.visitNode(e.references)),e.check&&(this.append(" "),this.visitNode(e.check)),e.endModifiers&&e.endModifiers.length>0&&(this.append(" "),this.compileList(e.endModifiers," "))}getAutoIncrement(){return"auto_increment"}visitReferences(e){this.append("references "),this.visitNode(e.table),this.append(" ("),this.compileList(e.columns),this.append(")"),e.onDelete&&(this.append(" on delete "),this.append(e.onDelete)),e.onUpdate&&(this.append(" on update "),this.append(e.onUpdate))}visitDropTable(e){this.append("drop table "),e.ifExists&&this.append("if exists "),this.visitNode(e.table),e.cascade&&this.append(" cascade")}visitDataType(e){this.append(e.dataType)}visitOrderBy(e){this.append("order by "),this.compileList(e.items)}visitOrderByItem(e){this.visitNode(e.orderBy),e.collation&&(this.append(" "),this.visitNode(e.collation)),e.direction&&(this.append(" "),this.visitNode(e.direction)),e.nulls&&(this.append(" nulls "),this.append(e.nulls))}visitGroupBy(e){this.append("group by "),this.compileList(e.items)}visitGroupByItem(e){this.visitNode(e.groupBy)}visitUpdateQuery(e){const t=void 0!==this.parentNode&&!A.is(this.parentNode)&&!d.is(this.parentNode)&&!W.is(this.parentNode);if(void 0===this.parentNode&&e.explain&&(this.visitNode(e.explain),this.append(" ")),t&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("update "),e.top&&(this.visitNode(e.top),this.append(" ")),e.table&&(this.visitNode(e.table),this.append(" ")),this.append("set "),e.updates&&this.compileList(e.updates),e.output&&(this.append(" "),this.visitNode(e.output)),e.from&&(this.append(" "),this.visitNode(e.from)),e.joins){if(!e.from)throw new Error("Joins in an update query are only supported as a part of a PostgreSQL 'update set from join' query. If you want to create a MySQL 'update join set' query, see https://kysely.dev/docs/examples/update/my-sql-joins");this.append(" "),this.compileList(e.joins," ")}e.where&&(this.append(" "),this.visitNode(e.where)),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.returning&&(this.append(" "),this.visitNode(e.returning)),t&&this.append(")"),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitColumnUpdate(e){this.visitNode(e.column),this.append(" = "),this.visitNode(e.value)}visitLimit(e){this.append("limit "),this.visitNode(e.limit)}visitOffset(e){this.append("offset "),this.visitNode(e.offset)}visitOnConflict(e){this.append("on conflict"),e.columns?(this.append(" ("),this.compileList(e.columns),this.append(")")):e.constraint?(this.append(" on constraint "),this.visitNode(e.constraint)):e.indexExpression&&(this.append(" ("),this.visitNode(e.indexExpression),this.append(")")),e.indexWhere&&(this.append(" "),this.visitNode(e.indexWhere)),!0===e.doNothing?this.append(" do nothing"):e.updates&&(this.append(" do update set "),this.compileList(e.updates),e.updateWhere&&(this.append(" "),this.visitNode(e.updateWhere)))}visitOnDuplicateKey(e){this.append("on duplicate key update "),this.compileList(e.updates)}visitCreateIndex(e){this.append("create "),e.unique&&this.append("unique "),this.append("index "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),e.table&&(this.append(" on "),this.visitNode(e.table)),e.using&&(this.append(" using "),this.visitNode(e.using)),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.nullsNotDistinct&&this.append(" nulls not distinct"),e.where&&(this.append(" "),this.visitNode(e.where))}visitDropIndex(e){this.append("drop index "),e.ifExists&&this.append("if exists "),this.visitNode(e.name),e.table&&(this.append(" on "),this.visitNode(e.table)),e.cascade&&this.append(" cascade")}visitCreateSchema(e){this.append("create schema "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.schema)}visitDropSchema(e){this.append("drop schema "),e.ifExists&&this.append("if exists "),this.visitNode(e.schema),e.cascade&&this.append(" cascade")}visitPrimaryKeyConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("primary key ("),this.compileList(e.columns),this.append(")"),this.buildDeferrable(e)}buildDeferrable(e){void 0!==e.deferrable&&(e.deferrable?this.append(" deferrable"):this.append(" not deferrable")),void 0!==e.initiallyDeferred&&(e.initiallyDeferred?this.append(" initially deferred"):this.append(" initially immediate"))}visitUniqueConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("unique"),e.nullsNotDistinct&&this.append(" nulls not distinct"),this.append(" ("),this.compileList(e.columns),this.append(")"),this.buildDeferrable(e)}visitCheckConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("check ("),this.visitNode(e.expression),this.append(")")}visitForeignKeyConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("foreign key ("),this.compileList(e.columns),this.append(") "),this.visitNode(e.references),e.onDelete&&(this.append(" on delete "),this.append(e.onDelete)),e.onUpdate&&(this.append(" on update "),this.append(e.onUpdate)),this.buildDeferrable(e)}visitList(e){this.compileList(e.items)}visitWith(e){this.append("with "),e.recursive&&this.append("recursive "),this.compileList(e.expressions)}visitCommonTableExpression(e){this.visitNode(e.name),this.append(" as "),Q(e.materialized)&&(e.materialized||this.append("not "),this.append("materialized ")),this.visitNode(e.expression)}visitCommonTableExpressionName(e){this.visitNode(e.table),e.columns&&(this.append("("),this.compileList(e.columns),this.append(")"))}visitAlterTable(e){this.append("alter table "),this.visitNode(e.table),this.append(" "),e.renameTo&&(this.append("rename to "),this.visitNode(e.renameTo)),e.setSchema&&(this.append("set schema "),this.visitNode(e.setSchema)),e.addConstraint&&this.visitNode(e.addConstraint),e.dropConstraint&&this.visitNode(e.dropConstraint),e.renameConstraint&&this.visitNode(e.renameConstraint),e.columnAlterations&&this.compileColumnAlterations(e.columnAlterations),e.addIndex&&this.visitNode(e.addIndex),e.dropIndex&&this.visitNode(e.dropIndex)}visitAddColumn(e){this.append("add column "),this.visitNode(e.column)}visitRenameColumn(e){this.append("rename column "),this.visitNode(e.column),this.append(" to "),this.visitNode(e.renameTo)}visitDropColumn(e){this.append("drop column "),this.visitNode(e.column)}visitAlterColumn(e){this.append("alter column "),this.visitNode(e.column),this.append(" "),e.dataType&&(this.announcesNewColumnDataType()&&this.append("type "),this.visitNode(e.dataType),e.dataTypeExpression&&(this.append("using "),this.visitNode(e.dataTypeExpression))),e.setDefault&&(this.append("set default "),this.visitNode(e.setDefault)),e.dropDefault&&this.append("drop default"),e.setNotNull&&this.append("set not null"),e.dropNotNull&&this.append("drop not null")}visitModifyColumn(e){this.append("modify column "),this.visitNode(e.column)}visitAddConstraint(e){this.append("add "),this.visitNode(e.constraint)}visitDropConstraint(e){this.append("drop constraint "),e.ifExists&&this.append("if exists "),this.visitNode(e.constraintName),"cascade"===e.modifier?this.append(" cascade"):"restrict"===e.modifier&&this.append(" restrict")}visitRenameConstraint(e){this.append("rename constraint "),this.visitNode(e.oldName),this.append(" to "),this.visitNode(e.newName)}visitSetOperation(e){this.append(e.operator),this.append(" "),e.all&&this.append("all "),this.visitNode(e.expression)}visitCreateView(e){this.append("create "),e.orReplace&&this.append("or replace "),e.materialized&&this.append("materialized "),e.temporary&&this.append("temporary "),this.append("view "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),this.append(" "),e.columns&&(this.append("("),this.compileList(e.columns),this.append(") ")),e.as&&(this.append("as "),this.visitNode(e.as))}visitRefreshMaterializedView(e){this.append("refresh materialized view "),e.concurrently&&this.append("concurrently "),this.visitNode(e.name),e.withNoData?this.append(" with no data"):this.append(" with data")}visitDropView(e){this.append("drop "),e.materialized&&this.append("materialized "),this.append("view "),e.ifExists&&this.append("if exists "),this.visitNode(e.name),e.cascade&&this.append(" cascade")}visitGenerated(e){this.append("generated "),e.always&&this.append("always "),e.byDefault&&this.append("by default "),this.append("as "),e.identity&&this.append("identity"),e.expression&&(this.append("("),this.visitNode(e.expression),this.append(")")),e.stored&&this.append(" stored")}visitDefaultValue(e){this.append("default "),this.visitNode(e.defaultValue)}visitSelectModifier(e){e.rawModifier?this.visitNode(e.rawModifier):this.append(Ft[e.modifier]),e.of&&(this.append(" of "),this.compileList(e.of,", "))}visitCreateType(e){this.append("create type "),this.visitNode(e.name),e.enum&&(this.append(" as enum "),this.visitNode(e.enum))}visitDropType(e){this.append("drop type "),e.ifExists&&this.append("if exists "),this.visitNode(e.name)}visitExplain(e){this.append("explain"),(e.options||e.format)&&(this.append(" "),this.append(this.getLeftExplainOptionsWrapper()),e.options&&(this.visitNode(e.options),e.format&&this.append(this.getExplainOptionsDelimiter())),e.format&&(this.append("format"),this.append(this.getExplainOptionAssignment()),this.append(e.format)),this.append(this.getRightExplainOptionsWrapper()))}visitDefaultInsertValue(e){this.append("default")}visitAggregateFunction(e){this.append(e.func),this.append("("),e.distinct&&this.append("distinct "),this.compileList(e.aggregated),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),this.append(")"),e.withinGroup&&(this.append(" within group ("),this.visitNode(e.withinGroup),this.append(")")),e.filter&&(this.append(" filter("),this.visitNode(e.filter),this.append(")")),e.over&&(this.append(" "),this.visitNode(e.over))}visitOver(e){this.append("over("),e.partitionBy&&(this.visitNode(e.partitionBy),e.orderBy&&this.append(" ")),e.orderBy&&this.visitNode(e.orderBy),this.append(")")}visitPartitionBy(e){this.append("partition by "),this.compileList(e.items)}visitPartitionByItem(e){this.visitNode(e.partitionBy)}visitBinaryOperation(e){this.visitNode(e.leftOperand),this.append(" "),this.visitNode(e.operator),this.append(" "),this.visitNode(e.rightOperand)}visitUnaryOperation(e){this.visitNode(e.operator),this.isMinusOperator(e.operator)||this.append(" "),this.visitNode(e.operand)}isMinusOperator(e){return R.is(e)&&"-"===e.operator}visitUsing(e){this.append("using "),this.compileList(e.tables)}visitFunction(e){this.append(e.func),this.append("("),this.compileList(e.arguments),this.append(")")}visitCase(e){this.append("case"),e.value&&(this.append(" "),this.visitNode(e.value)),e.when&&(this.append(" "),this.compileList(e.when," ")),e.else&&(this.append(" else "),this.visitNode(e.else)),this.append(" end"),e.isStatement&&this.append(" case")}visitWhen(e){this.append("when "),this.visitNode(e.condition),e.result&&(this.append(" then "),this.visitNode(e.result))}visitJSONReference(e){this.visitNode(e.reference),this.visitNode(e.traversal)}visitJSONPath(e){e.inOperator&&this.visitNode(e.inOperator),this.append("'$");for(const t of e.pathLegs)this.visitNode(t);this.append("'")}visitJSONPathLeg(e){const t="ArrayLocation"===e.type;this.append(t?"[":"."),this.append(String(e.value)),t&&this.append("]")}visitJSONOperatorChain(e){for(let t=0,i=e.values.length;t<i;t++)t===i-1?this.visitNode(e.operator):this.append("->"),this.visitNode(e.values[t])}visitMergeQuery(e){e.with&&(this.visitNode(e.with),this.append(" ")),this.append("merge "),e.top&&(this.visitNode(e.top),this.append(" ")),this.append("into "),this.visitNode(e.into),e.using&&(this.append(" "),this.visitNode(e.using)),e.whens&&(this.append(" "),this.compileList(e.whens," ")),e.returning&&(this.append(" "),this.visitNode(e.returning)),e.output&&(this.append(" "),this.visitNode(e.output)),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitMatched(e){e.not&&this.append("not "),this.append("matched"),e.bySource&&this.append(" by source")}visitAddIndex(e){this.append("add "),e.unique&&this.append("unique "),this.append("index "),this.visitNode(e.name),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.using&&(this.append(" using "),this.visitNode(e.using))}visitCast(e){this.append("cast("),this.visitNode(e.expression),this.append(" as "),this.visitNode(e.dataType),this.append(")")}visitFetch(e){this.append("fetch next "),this.visitNode(e.rowCount),this.append(` rows ${e.modifier}`)}visitOutput(e){this.append("output "),this.compileList(e.selections)}visitTop(e){this.append(`top(${e.expression})`),e.modifiers&&this.append(` ${e.modifiers}`)}visitOrAction(e){this.append(e.action)}visitCollate(e){this.append("collate "),this.visitNode(e.collation)}append(e){this.#k+=e}appendValue(e){this.addParameter(e),this.append(this.getCurrentParameterPlaceholder())}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getCurrentParameterPlaceholder(){return"$"+this.numParameters}getLeftExplainOptionsWrapper(){return"("}getExplainOptionAssignment(){return" "}getExplainOptionsDelimiter(){return", "}getRightExplainOptionsWrapper(){return")"}sanitizeIdentifier(e){const t=this.getLeftIdentifierWrapper(),i=this.getRightIdentifierWrapper();let s="";for(const n of e)s+=n,n===t?s+=t:n===i&&(s+=i);return s}sanitizeStringLiteral(e){return e.replace(Ut,"''")}addParameter(e){this.#S.push(e)}appendImmediateValue(e){if(q(e))this.appendStringLiteral(e);else if(B(e)||Q(e)||U(e))this.append(e.toString());else if($(e))this.append("null");else{if(!F(e))throw new Error(`invalid immediate value ${e}`);this.appendImmediateValue(e.toISOString())}}appendStringLiteral(e){this.append("'"),this.append(this.sanitizeStringLiteral(e)),this.append("'")}sortSelectModifiers(t){return t.sort(((e,t)=>e.modifier&&t.modifier?Vt[e.modifier]-Vt[t.modifier]:1)),e(t)}compileColumnAlterations(e){this.compileList(e)}announcesNewColumnDataType(){return!0}}const Ft=e({ForKeyShare:"for key share",ForNoKeyUpdate:"for no key update",ForUpdate:"for update",ForShare:"for share",NoWait:"nowait",SkipLocked:"skip locked",Distinct:"distinct"}),Vt=e({ForKeyShare:1,ForNoKeyUpdate:1,ForUpdate:1,ForShare:1,NoWait:2,SkipLocked:2,Distinct:0}),jt=e({InnerJoin:"inner join",LeftJoin:"left join",RightJoin:"right join",FullJoin:"full join",CrossJoin:"cross join",LateralInnerJoin:"inner join lateral",LateralLeftJoin:"left join lateral",LateralCrossJoin:"cross join lateral",OuterApply:"outer apply",CrossApply:"cross apply",Using:"using"}),Jt=e({raw:(t,i=[])=>e({sql:t,query:d.createWithSql(t),parameters:e(i),queryId:v()})});class Kt{async init(){}async acquireConnection(){return new zt}async beginTransaction(){}async commitTransaction(){}async rollbackTransaction(){}async releaseConnection(){}async destroy(){}async releaseSavepoint(){}async rollbackToSavepoint(){}async savepoint(){}}class zt{async executeQuery(){return{rows:[]}}async*streamQuery(){}}class Gt{get supportsCreateIfNotExists(){return!0}get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}get supportsOutput(){return!1}}function Yt(e,i){return d.createWithChildren([d.createWithSql(`${e} `),t.create(i)])}class Ht{#M;#D=new Zt;#A;#N;constructor(t){this.#M=e({...t})}async init(){this.#A=T(this.#M.database)?await this.#M.database():this.#M.database,this.#N=new Xt(this.#A),this.#M.onCreateConnection&&await this.#M.onCreateConnection(this.#N)}async acquireConnection(){return await this.#D.lock(),this.#N}async beginTransaction(e){await e.executeQuery(Jt.raw("begin"))}async commitTransaction(e){await e.executeQuery(Jt.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(Jt.raw("rollback"))}async savepoint(e,t,i){await e.executeQuery(i(Yt("savepoint",t),v()))}async rollbackToSavepoint(e,t,i){await e.executeQuery(i(Yt("rollback to",t),v()))}async releaseSavepoint(e,t,i){await e.executeQuery(i(Yt("release",t),v()))}async releaseConnection(){this.#D.unlock()}async destroy(){this.#A?.close()}}class Xt{#A;constructor(e){this.#A=e}executeQuery(e){const{sql:t,parameters:i}=e,s=this.#A.prepare(t);if(s.reader)return Promise.resolve({rows:s.all(i)});const{changes:n,lastInsertRowid:r}=s.run(i);return Promise.resolve({numAffectedRows:null!=n?BigInt(n):void 0,insertId:null!=r?BigInt(r):void 0,rows:[]})}async*streamQuery(e,t){const{sql:i,parameters:s,query:n}=e,r=this.#A.prepare(i);if(!V.is(n))throw new Error("Sqlite driver only supports streaming of select queries");{const e=r.iterate(s);for(const t of e)yield{rows:[t]}}}}class Zt{#L;#P;async lock(){for(;this.#L;)await this.#L;this.#L=new Promise((e=>{this.#P=e}))}unlock(){const e=this.#P;this.#L=void 0,this.#P=void 0,e?.()}}const ei=/"/g;class ti extends $t{visitOrAction(e){this.append("or "),this.append(e.action)}getCurrentParameterPlaceholder(){return"?"}getLeftExplainOptionsWrapper(){return""}getRightExplainOptionsWrapper(){return""}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getAutoIncrement(){return"autoincrement"}sanitizeIdentifier(e){return e.replace(ei,'""')}visitDefaultInsertValue(e){this.append("null")}}class ii{transformQuery(e){return e.node}async transformResult(e){return e.result}}const si="kysely_migration",ni="kysely_migration_lock",ri=!1,oi="migration_lock",pi=e({__noMigrations__:!0});class ci{#s;constructor(t){this.#s=e(t)}async getMigrations(){const e=await this.#W(this.#q)?await this.#s.db.withPlugin(this.#Q).selectFrom(this.#q).select(["name","timestamp"]).$narrowType().execute():[];return(await this.#R()).map((({name:t,...i})=>{const s=e.find((e=>e.name===t));return{name:t,migration:i,executedAt:s?new Date(s.timestamp):void 0}}))}async migrateToLatest(){return this.#B((()=>({direction:"Up",step:1/0})))}async migrateTo(e){return this.#B((({migrations:t,executedMigrations:i,pendingMigrations:s})=>{if(E(e)&&!0===e.__noMigrations__)return{direction:"Down",step:1/0};if(!t.find((t=>t.name===e)))throw new Error(`migration "${e}" doesn't exist`);const n=i.indexOf(e),r=s.findIndex((t=>t.name===e));if(-1!==n)return{direction:"Down",step:i.length-n-1};if(-1!==r)return{direction:"Up",step:r+1};throw new Error(`migration "${e}" isn't executed or pending`)}))}async migrateUp(){return this.#B((()=>({direction:"Up",step:1})))}async migrateDown(){return this.#B((()=>({direction:"Down",step:1})))}async#B(e){try{return await this.#U(),await this.#$(e)}catch(e){return e instanceof di?e.resultSet:{error:e}}}get#F(){return this.#s.migrationTableSchema}get#q(){return this.#s.migrationTableName??si}get#V(){return this.#s.migrationLockTableName??ni}get#j(){return this.#s.allowUnorderedMigrations??false}get#Q(){return this.#F?new N(this.#F):new ii}async#U(){await this.#J(),await this.#K(),await this.#z(),await this.#G()}async#J(){if(this.#F&&!await this.#Y())try{await this.#H(this.#s.db.schema.createSchema(this.#F))}catch(e){if(!await this.#Y())throw e}}async#K(){if(!await this.#W(this.#q))try{this.#F&&await this.#H(this.#s.db.schema.createSchema(this.#F)),await this.#H(this.#s.db.schema.withPlugin(this.#Q).createTable(this.#q).addColumn("name","varchar(255)",(e=>e.notNull().primaryKey())).addColumn("timestamp","varchar(255)",(e=>e.notNull())))}catch(e){if(!await this.#W(this.#q))throw e}}async#z(){if(!await this.#W(this.#V))try{await this.#H(this.#s.db.schema.withPlugin(this.#Q).createTable(this.#V).addColumn("id","varchar(255)",(e=>e.notNull().primaryKey())).addColumn("is_locked","integer",(e=>e.notNull().defaultTo(0))))}catch(e){if(!await this.#W(this.#V))throw e}}async#G(){if(!await this.#X())try{await this.#s.db.withPlugin(this.#Q).insertInto(this.#V).values({id:oi,is_locked:0}).execute()}catch(e){if(!await this.#X())throw e}}async#Y(){return(await this.#s.db.introspection.getSchemas()).some((e=>e.name===this.#F))}async#W(e){const t=this.#F;return(await this.#s.db.introspection.getTables({withInternalKyselyTables:!0})).some((i=>i.name===e&&(!t||i.schema===t)))}async#X(){return!!await this.#s.db.withPlugin(this.#Q).selectFrom(this.#V).where("id","=",oi).select("id").executeTakeFirst()}async#$(t){const i=this.#s.db.getExecutor().adapter,s=e({lockTable:this.#s.migrationLockTableName??ni,lockRowId:oi,lockTableSchema:this.#s.migrationTableSchema}),n=async e=>{try{await i.acquireMigrationLock(e,s);const n=await this.#Z(e);if(0===n.migrations.length)return{results:[]};const{direction:r,step:o}=t(n);return o<=0?{results:[]}:"Down"===r?await this.#ee(e,n,o):"Up"===r?await this.#te(e,n,o):{results:[]}}finally{await i.releaseMigrationLock(e,s)}};return i.supportsTransactionalDdl&&!this.#s.disableTransactions?this.#s.db.transaction().execute(n):this.#s.db.connection().execute(n)}async#Z(t){const i=await this.#R(),s=await this.#ie(t);this.#se(i,s),this.#j||this.#ne(i,s);const n=this.#re(i,s);return e({migrations:i,executedMigrations:s,lastMigration:j(s),pendingMigrations:n})}#re(e,t){return e.filter((e=>!t.includes(e.name)))}async#R(){const e=await this.#s.provider.getMigrations();return Object.keys(e).sort().map((t=>({...e[t],name:t})))}async#ie(e){const t=await e.withPlugin(this.#Q).selectFrom(this.#q).select(["name","timestamp"]).$narrowType().execute(),i=this.#s.nameComparator||((e,t)=>e.localeCompare(t));return t.sort(((e,t)=>e.timestamp===t.timestamp?i(e.name,t.name):new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime())).map((e=>e.name))}#se(e,t){for(const i of t)if(!e.some((e=>e.name===i)))throw new Error(`corrupted migrations: previously executed migration ${i} is missing`)}#ne(e,t){for(let i=0;i<t.length;++i)if(e[i].name!==t[i])throw new Error(`corrupted migrations: expected previously executed migration ${t[i]} to be at index ${i} but ${e[i].name} was found in its place. New migrations must always have a name that comes alphabetically after the last executed migration.`)}async#ee(e,t,i){const s=t.executedMigrations.slice().reverse().slice(0,i).map((e=>t.migrations.find((t=>t.name===e)))),n=s.map((e=>({migrationName:e.name,direction:"Down",status:"NotExecuted"})));for(let t=0;t<n.length;++t){const i=s[t];try{i.down&&(await i.down(e),await e.withPlugin(this.#Q).deleteFrom(this.#q).where("name","=",i.name).execute(),n[t]={migrationName:i.name,direction:"Down",status:"Success"})}catch(e){throw n[t]={migrationName:i.name,direction:"Down",status:"Error"},new di({error:e,results:n})}}return{results:n}}async#te(e,t,i){const s=t.pendingMigrations.slice(0,i).map((e=>({migrationName:e.name,direction:"Up",status:"NotExecuted"})));for(let i=0;i<s.length;i++){const n=t.pendingMigrations[i];try{await n.up(e),await e.withPlugin(this.#Q).insertInto(this.#q).values({name:n.name,timestamp:(new Date).toISOString()}).execute(),s[i]={migrationName:n.name,direction:"Up",status:"Success"}}catch(e){throw s[i]={migrationName:n.name,direction:"Up",status:"Error"},new di({error:e,results:s})}}return{results:s}}async#H(e){this.#s.db.getExecutor().adapter.supportsCreateIfNotExists&&(e=e.ifNotExists()),await e.execute()}}class di extends Error{#oe;constructor(e){super(),this.#oe=e}get resultSet(){return this.#oe}}class hi{#A;constructor(e){this.#A=e}async getSchemas(){return[]}async getTables(e={withInternalKyselyTables:!1}){return await this.#ae(e)}async getMetadata(e){return{tables:await this.getTables(e)}}#pe(e,t){let i=e.selectFrom("sqlite_master").where("type","in",["table","view"]).where("name","not like","sqlite_%").select(["name","sql","type"]).orderBy("name");return t.withInternalKyselyTables||(i=i.where("name","!=",si).where("name","!=",ni)),i}async#ae(e){const t=await this.#pe(this.#A,e).execute(),i=await this.#A.with("table_list",(t=>this.#pe(t,e))).selectFrom(["table_list as tl",J`pragma_table_info(tl.name)`.as("p")]).select(["tl.name as table","p.cid","p.name","p.type","p.notnull","p.dflt_value","p.pk"]).orderBy("tl.name").orderBy("p.cid").execute(),s={};for(const e of i)s[e.table]??=[],s[e.table].push(e);return t.map((({name:e,sql:t,type:i})=>{let n=t?.split(/[\(\),]/)?.find((e=>e.toLowerCase().includes("autoincrement")))?.trimStart()?.split(/\s+/)?.[0]?.replace(/["`]/g,"");const r=s[e]??[];if(!n){const e=r.filter((e=>e.pk>0));1===e.length&&"integer"===e[0].type.toLowerCase()&&(n=e[0].name)}return{name:e,isView:"view"===i,columns:r.map((e=>({name:e.name,dataType:e.type,isNullable:!e.notnull,isAutoIncrementing:e.name===n,hasDefaultValue:null!=e.dflt_value,comment:void 0})))}}))}}class li extends Gt{get supportsTransactionalDdl(){return!1}get supportsReturning(){return!0}async acquireMigrationLock(e,t){}async releaseMigrationLock(e,t){}}class ui{#M;constructor(t){this.#M=e({...t})}createDriver(){return new Ht(this.#M)}createQueryCompiler(){return new ti}createAdapter(){return new li}createIntrospector(e){return new hi(e)}}const mi=/"/g;class yi extends $t{sanitizeIdentifier(e){return e.replace(mi,'""')}}class wi{#A;constructor(e){this.#A=e}async getSchemas(){return(await this.#A.selectFrom("pg_catalog.pg_namespace").select("nspname").$castTo().execute()).map((e=>({name:e.nspname})))}async getTables(e={withInternalKyselyTables:!1}){let t=this.#A.selectFrom("pg_catalog.pg_attribute as a").innerJoin("pg_catalog.pg_class as c","a.attrelid","c.oid").innerJoin("pg_catalog.pg_namespace as ns","c.relnamespace","ns.oid").innerJoin("pg_catalog.pg_type as typ","a.atttypid","typ.oid").innerJoin("pg_catalog.pg_namespace as dtns","typ.typnamespace","dtns.oid").select(["a.attname as column","a.attnotnull as not_null","a.atthasdef as has_default","c.relname as table","c.relkind as table_type","ns.nspname as schema","typ.typname as type","dtns.nspname as type_schema",J`col_description(a.attrelid, a.attnum)`.as("column_description"),J`pg_get_serial_sequence(quote_ident(ns.nspname) || '.' || quote_ident(c.relname), a.attname)`.as("auto_incrementing")]).where("c.relkind","in",["r","v","p"]).where("ns.nspname","!~","^pg_").where("ns.nspname","!=","information_schema").where("ns.nspname","!=","crdb_internal").where(J`has_schema_privilege(ns.nspname, 'USAGE')`).where("a.attnum",">=",0).where("a.attisdropped","!=",!0).orderBy("ns.nspname").orderBy("c.relname").orderBy("a.attnum").$castTo();e.withInternalKyselyTables||(t=t.where("c.relname","!=",si).where("c.relname","!=",ni));const i=await t.execute();return this.#ce(i)}async getMetadata(e){return{tables:await this.getTables(e)}}#ce(t){return t.reduce(((t,i)=>{let s=t.find((e=>e.name===i.table&&e.schema===i.schema));return s||(s=e({name:i.table,isView:"v"===i.table_type,schema:i.schema,columns:[]}),t.push(s)),s.columns.push(e({name:i.column,dataType:i.type,dataTypeSchema:i.type_schema,isNullable:!i.not_null,isAutoIncrementing:null!==i.auto_incrementing,hasDefaultValue:i.has_default,comment:i.column_description??void 0})),t}),[])}}const fi=BigInt("3853314791062309107");class gi extends Gt{get supportsTransactionalDdl(){return!0}get supportsReturning(){return!0}async acquireMigrationLock(e,t){await J`select pg_advisory_xact_lock(${J.lit(fi)})`.execute(e)}async releaseMigrationLock(e,t){}}function vi(e,t){if(E(i=e)&&q(i.stack)&&t.stack){const i=t.stack.split("\n").slice(1).join("\n");return e.stack+=`\n${i}`,e}var i;return e}const Ni=Symbol();class xi{#M;#m=new WeakMap;#de;constructor(t){this.#M=e({...t})}async init(){this.#de=T(this.#M.pool)?await this.#M.pool():this.#M.pool}async acquireConnection(){const e=await this.#he();let t=this.#m.get(e);return t||(t=new Ci(e),this.#m.set(e,t),this.#M?.onCreateConnection&&await this.#M.onCreateConnection(t)),this.#M?.onReserveConnection&&await this.#M.onReserveConnection(t),t}async#he(){return new Promise(((e,t)=>{this.#de.getConnection((async(i,s)=>{i?t(i):e(s)}))}))}async beginTransaction(e,t){if(t.isolationLevel||t.accessMode){const i=[];t.isolationLevel&&i.push(`isolation level ${t.isolationLevel}`),t.accessMode&&i.push(t.accessMode);const s=`set transaction ${i.join(", ")}`;await e.executeQuery(Jt.raw(s))}await e.executeQuery(Jt.raw("begin"))}async commitTransaction(e){await e.executeQuery(Jt.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(Jt.raw("rollback"))}async savepoint(e,t,i){await e.executeQuery(i(Yt("savepoint",t),v()))}async rollbackToSavepoint(e,t,i){await e.executeQuery(i(Yt("rollback to",t),v()))}async releaseSavepoint(e,t,i){await e.executeQuery(i(Yt("release savepoint",t),v()))}async releaseConnection(e){e[Ni]()}async destroy(){return new Promise(((e,t)=>{this.#de.end((i=>{i?t(i):e()}))}))}}class Ci{#le;constructor(e){this.#le=e}async executeQuery(e){try{const i=await this.#ue(e);if(E(t=i)&&"insertId"in t&&"affectedRows"in t){const{insertId:e,affectedRows:t,changedRows:s}=i;return{insertId:null!=e&&"0"!==e.toString()?BigInt(e):void 0,numAffectedRows:null!=t?BigInt(t):void 0,numChangedRows:null!=s?BigInt(s):void 0,rows:[]}}return Array.isArray(i)?{rows:i}:{rows:[]}}catch(e){throw vi(e,new Error)}var t}#ue(e){return new Promise(((t,i)=>{this.#le.query(e.sql,e.parameters,((e,s)=>{e?i(e):t(s)}))}))}async*streamQuery(e,t){const i=this.#le.query(e.sql,e.parameters).stream({objectMode:!0});try{for await(const e of i)yield{rows:[e]}}catch(e){if(e&&"object"==typeof e&&"code"in e&&"ERR_STREAM_PREMATURE_CLOSE"===e.code)return;throw e}}[Ni](){this.#le.release()}}const Ti=/`/g;class Ei extends $t{getCurrentParameterPlaceholder(){return"?"}getLeftExplainOptionsWrapper(){return""}getExplainOptionAssignment(){return"="}getExplainOptionsDelimiter(){return" "}getRightExplainOptionsWrapper(){return""}getLeftIdentifierWrapper(){return"`"}getRightIdentifierWrapper(){return"`"}sanitizeIdentifier(e){return e.replace(Ti,"``")}visitCreateIndex(e){this.append("create "),e.unique&&this.append("unique "),this.append("index "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),e.using&&(this.append(" using "),this.visitNode(e.using)),e.table&&(this.append(" on "),this.visitNode(e.table)),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.where&&(this.append(" "),this.visitNode(e.where))}}class _i{#A;constructor(e){this.#A=e}async getSchemas(){return(await this.#A.selectFrom("information_schema.schemata").select("schema_name").$castTo().execute()).map((e=>({name:e.SCHEMA_NAME})))}async getTables(e={withInternalKyselyTables:!1}){let t=this.#A.selectFrom("information_schema.columns as columns").innerJoin("information_schema.tables as tables",(e=>e.onRef("columns.TABLE_CATALOG","=","tables.TABLE_CATALOG").onRef("columns.TABLE_SCHEMA","=","tables.TABLE_SCHEMA").onRef("columns.TABLE_NAME","=","tables.TABLE_NAME"))).select(["columns.COLUMN_NAME","columns.COLUMN_DEFAULT","columns.TABLE_NAME","columns.TABLE_SCHEMA","tables.TABLE_TYPE","columns.IS_NULLABLE","columns.DATA_TYPE","columns.EXTRA","columns.COLUMN_COMMENT"]).where("columns.TABLE_SCHEMA","=",J`database()`).orderBy("columns.TABLE_NAME").orderBy("columns.ORDINAL_POSITION").$castTo();e.withInternalKyselyTables||(t=t.where("columns.TABLE_NAME","!=",si).where("columns.TABLE_NAME","!=",ni));const i=await t.execute();return this.#ce(i)}async getMetadata(e){return{tables:await this.getTables(e)}}#ce(t){return t.reduce(((t,i)=>{let s=t.find((e=>e.name===i.TABLE_NAME));return s||(s=e({name:i.TABLE_NAME,isView:"VIEW"===i.TABLE_TYPE,schema:i.TABLE_SCHEMA,columns:[]}),t.push(s)),s.columns.push(e({name:i.COLUMN_NAME,dataType:i.DATA_TYPE,isNullable:"YES"===i.IS_NULLABLE,isAutoIncrementing:i.EXTRA.toLowerCase().includes("auto_increment"),hasDefaultValue:null!==i.COLUMN_DEFAULT,comment:""===i.COLUMN_COMMENT?void 0:i.COLUMN_COMMENT})),t}),[])}}const Oi="ea586330-2c93-47c8-908d-981d9d270f9d";class Ii extends Gt{get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}async acquireMigrationLock(e,t){await J`select get_lock(${J.lit(Oi)}, ${J.lit(3600)})`.execute(e)}async releaseMigrationLock(e,t){await J`select release_lock(${J.lit(Oi)})`.execute(e)}}class ki{#M;constructor(e){this.#M=e}createDriver(){return new xi(this.#M)}createQueryCompiler(){return new Ei}createAdapter(){return new Ii}createIntrospector(e){return new _i(e)}}const Si=Symbol();class Mi{#M;#m=new WeakMap;#de;constructor(t){this.#M=e({...t})}async init(){this.#de=T(this.#M.pool)?await this.#M.pool():this.#M.pool}async acquireConnection(){const e=await this.#de.connect();let t=this.#m.get(e);return t||(t=new Di(e,{cursor:this.#M.cursor??null}),this.#m.set(e,t),this.#M.onCreateConnection&&await this.#M.onCreateConnection(t)),this.#M.onReserveConnection&&await this.#M.onReserveConnection(t),t}async beginTransaction(e,t){if(t.isolationLevel||t.accessMode){let i="start transaction";t.isolationLevel&&(i+=` isolation level ${t.isolationLevel}`),t.accessMode&&(i+=` ${t.accessMode}`),await e.executeQuery(Jt.raw(i))}else await e.executeQuery(Jt.raw("begin"))}async commitTransaction(e){await e.executeQuery(Jt.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(Jt.raw("rollback"))}async savepoint(e,t,i){await e.executeQuery(i(Yt("savepoint",t),v()))}async rollbackToSavepoint(e,t,i){await e.executeQuery(i(Yt("rollback to",t),v()))}async releaseSavepoint(e,t,i){await e.executeQuery(i(Yt("release",t),v()))}async releaseConnection(e){e[Si]()}async destroy(){if(this.#de){const e=this.#de;this.#de=void 0,await e.end()}}}class Di{#me;#ye;constructor(e,t){this.#me=e,this.#ye=t}async executeQuery(e){try{const{command:t,rowCount:i,rows:s}=await this.#me.query(e.sql,[...e.parameters]);return{numAffectedRows:"INSERT"===t||"UPDATE"===t||"DELETE"===t||"MERGE"===t?BigInt(i):void 0,rows:s??[]}}catch(e){throw vi(e,new Error)}}async*streamQuery(e,t){if(!this.#ye.cursor)throw new Error("'cursor' is not present in your postgres dialect config. It's required to make streaming work in postgres.");if(!Number.isInteger(t)||t<=0)throw new Error("chunkSize must be a positive integer");const i=this.#me.query(new this.#ye.cursor(e.sql,e.parameters.slice()));try{for(;;){const e=await i.read(t);if(0===e.length)break;yield{rows:e}}}finally{await i.close()}}[Si](){this.#me.release()}}class Ai{#M;constructor(e){this.#M=e}createDriver(){return new Mi(this.#M)}createQueryCompiler(){return new yi}createAdapter(){return new gi}createIntrospector(e){return new wi(e)}}class Li extends Gt{get supportsCreateIfNotExists(){return!1}get supportsTransactionalDdl(){return!0}get supportsOutput(){return!0}async acquireMigrationLock(e){await J`exec sp_getapplock @DbPrincipal = ${J.lit("dbo")}, @Resource = ${J.lit(si)}, @LockMode = ${J.lit("Exclusive")}`.execute(e)}async releaseMigrationLock(){}}const Pi=Symbol(),Wi=Symbol(),qi=Symbol();class Qi{#M;#de;constructor(t){this.#M=e({...t});const{tarn:i,tedious:s,validateConnections:n}=this.#M,{validateConnections:r,...o}=i.options;this.#de=new i.Pool({...o,create:async()=>{const e=await s.connectionFactory();return await new Ri(e,s).connect()},destroy:async e=>{await e[Wi]()},validate:!1===n||!1===r?void 0:e=>e[qi]()})}async init(){}async acquireConnection(){return await this.#de.acquire().promise}async beginTransaction(e,t){await e.beginTransaction(t)}async commitTransaction(e){await e.commitTransaction()}async rollbackTransaction(e){await e.rollbackTransaction()}async savepoint(e,t){await e.savepoint(t)}async rollbackToSavepoint(e,t){await e.rollbackTransaction(t)}async releaseConnection(e){(this.#M.resetConnectionsOnRelease||this.#M.tedious.resetConnectionOnRelease)&&await e[Pi](),this.#de.release(e)}async destroy(){await this.#de.destroy()}}class Ri{#N;#we;#fe;constructor(e,t){this.#N=e,this.#we=!1,this.#fe=t}async beginTransaction(e){const{isolationLevel:t}=e;await new Promise(((e,i)=>this.#N.beginTransaction((t=>{t?i(t):e(void 0)}),t?K(8):void 0,t?this.#ge(t):void 0)))}async commitTransaction(){await new Promise(((e,t)=>this.#N.commitTransaction((i=>{i?t(i):e(void 0)}))))}async connect(){const{promise:e,reject:t,resolve:i}=new z;function s(){t(new Error("The connection ended without ever completing the connection"))}return this.#N.connect((e=>{if(e)return t(e);i()})),this.#N.on("error",(e=>{e instanceof Error&&"code"in e&&"ESOCKET"===e.code&&(this.#we=!0),console.error(e),t(e)})),this.#N.once("end",s),await e,this.#N.off("end",s),this}async executeQuery(e){try{const t=new z,i=new Bi({compiledQuery:e,tedious:this.#fe,onDone:t});this.#N.execSql(i.request);const{rowCount:s,rows:n}=await t.promise;return{numAffectedRows:void 0!==s?BigInt(s):void 0,rows:n}}catch(e){throw vi(e,new Error)}}async rollbackTransaction(e){await new Promise(((t,i)=>this.#N.rollbackTransaction((e=>{e?i(e):t(void 0)}),e)))}async savepoint(e){await new Promise(((t,i)=>this.#N.saveTransaction((e=>{e?i(e):t(void 0)}),e)))}async*streamQuery(e,t){if(!Number.isInteger(t)||t<=0)throw new Error("chunkSize must be a positive integer");const i=new Bi({compiledQuery:e,streamChunkSize:t,tedious:this.#fe});this.#N.execSql(i.request);try{for(;;){const e=await i.readChunk();if(0===e.length)break;if(yield{rows:e},e.length<t)break}}finally{await this.#ve(i)}}#ge(e){const{ISOLATION_LEVEL:t}=this.#fe,i={"read committed":t.READ_COMMITTED,"read uncommitted":t.READ_UNCOMMITTED,"repeatable read":t.REPEATABLE_READ,serializable:t.SERIALIZABLE,snapshot:t.SNAPSHOT}[e];if(void 0===i)throw new Error(`Unknown isolation level: ${e}`);return i}#ve(e){return new Promise((t=>{e.request.once("requestCompleted",t);this.#N.cancel()||(e.request.off("requestCompleted",t),t())}))}[Wi](){return"closed"in this.#N&&this.#N.closed?Promise.resolve():new Promise((e=>{this.#N.once("end",e),this.#N.close()}))}async[Pi](){await new Promise(((e,t)=>{this.#N.reset((i=>{if(i)return t(i);e()}))}))}async[qi](){if(this.#we||this.#Ne())return!1;try{const e=new z,t=new Bi({compiledQuery:Jt.raw("select 1"),onDone:e,tedious:this.#fe});return this.#N.execSql(t.request),await e.promise,!0}catch{return!1}}#Ne(){return"closed"in this.#N&&Boolean(this.#N.closed)}}class Bi{#be;#xe;#Ce;#Te;#fe;#Ee;constructor(e){const{compiledQuery:t,onDone:i,streamChunkSize:s,tedious:n}=e;if(this.#xe=[],this.#Ce=s,this.#Te={},this.#fe=n,i){const e="onDone";this.#Te[e]=(t,s)=>{if("chunkReady"!==t){if(delete this.#Te[e],"error"===t)return i.reject(s);i.resolve({rowCount:this.#Ee,rows:this.#xe})}}}this.#be=new this.#fe.Request(t.sql,((e,t)=>{if(e)return Object.values(this.#Te).forEach((t=>t("error",e instanceof AggregateError?e.errors:e)));this.#Ee=t})),this.#_e(t.parameters),this.#Oe()}get request(){return this.#be}readChunk(){const e=this.readChunk.name;return new Promise(((t,i)=>{this.#Te[e]=(s,n)=>{if(delete this.#Te[e],"error"===s)return i(n);t(this.#xe.splice(0,this.#Ce))},this.#be.resume()}))}#_e(e){for(let t=0;t<e.length;t++){const i=e[t];this.#be.addParameter(String(t+1),this.#Ie(i),i)}}#Oe(){const e=this.#Ce?()=>{this.#Ce<=this.#xe.length&&(this.#be.pause(),Object.values(this.#Te).forEach((e=>e("chunkReady"))))}:()=>{},t=t=>{const i={};for(const e of t)i[e.metadata.colName]=e.value;this.#xe.push(i),e()};this.#be.on("row",t),this.#be.once("requestCompleted",(()=>{Object.values(this.#Te).forEach((e=>e("completed"))),this.#be.off("row",t)}))}#Ie(e){return $(e)||k(e)||q(e)?this.#fe.TYPES.NVarChar:U(e)||B(e)&&e%1==0?e<-2147483648||e>2147483647?this.#fe.TYPES.BigInt:this.#fe.TYPES.Int:B(e)?this.#fe.TYPES.Float:Q(e)?this.#fe.TYPES.Bit:F(e)?this.#fe.TYPES.DateTime:G(e)?this.#fe.TYPES.VarBinary:this.#fe.TYPES.NVarChar}}class Ui{#A;constructor(e){this.#A=e}async getSchemas(){return await this.#A.selectFrom("sys.schemas").select("name").execute()}async getTables(t={withInternalKyselyTables:!1}){const i=await this.#A.selectFrom("sys.tables as tables").leftJoin("sys.schemas as table_schemas","table_schemas.schema_id","tables.schema_id").innerJoin("sys.columns as columns","columns.object_id","tables.object_id").innerJoin("sys.types as types","types.user_type_id","columns.user_type_id").leftJoin("sys.schemas as type_schemas","type_schemas.schema_id","types.schema_id").leftJoin("sys.extended_properties as comments",(e=>e.onRef("comments.major_id","=","tables.object_id").onRef("comments.minor_id","=","columns.column_id").on("comments.name","=","MS_Description"))).$if(!t.withInternalKyselyTables,(e=>e.where("tables.name","!=",si).where("tables.name","!=",ni))).select(["tables.name as table_name",e=>e.ref("tables.type").$castTo().as("table_type"),"table_schemas.name as table_schema_name","columns.default_object_id as column_default_object_id","columns.generated_always_type_desc as column_generated_always_type","columns.is_computed as column_is_computed","columns.is_identity as column_is_identity","columns.is_nullable as column_is_nullable","columns.is_rowguidcol as column_is_rowguidcol","columns.name as column_name","types.is_nullable as type_is_nullable","types.name as type_name","type_schemas.name as type_schema_name","comments.value as column_comment"]).unionAll(this.#A.selectFrom("sys.views as views").leftJoin("sys.schemas as view_schemas","view_schemas.schema_id","views.schema_id").innerJoin("sys.columns as columns","columns.object_id","views.object_id").innerJoin("sys.types as types","types.user_type_id","columns.user_type_id").leftJoin("sys.schemas as type_schemas","type_schemas.schema_id","types.schema_id").leftJoin("sys.extended_properties as comments",(e=>e.onRef("comments.major_id","=","views.object_id").onRef("comments.minor_id","=","columns.column_id").on("comments.name","=","MS_Description"))).select(["views.name as table_name","views.type as table_type","view_schemas.name as table_schema_name","columns.default_object_id as column_default_object_id","columns.generated_always_type_desc as column_generated_always_type","columns.is_computed as column_is_computed","columns.is_identity as column_is_identity","columns.is_nullable as column_is_nullable","columns.is_rowguidcol as column_is_rowguidcol","columns.name as column_name","types.is_nullable as type_is_nullable","types.name as type_name","type_schemas.name as type_schema_name","comments.value as column_comment"])).orderBy("table_schema_name").orderBy("table_name").orderBy("column_name").execute(),s={};for(const t of i){const i=`${t.table_schema_name}.${t.table_name}`;(s[i]=s[i]||e({columns:[],isView:"V "===t.table_type,name:t.table_name,schema:t.table_schema_name??void 0})).columns.push(e({dataType:t.type_name,dataTypeSchema:t.type_schema_name??void 0,hasDefaultValue:t.column_default_object_id>0||"NOT_APPLICABLE"!==t.column_generated_always_type||t.column_is_identity||t.column_is_computed||t.column_is_rowguidcol,isAutoIncrementing:t.column_is_identity,isNullable:t.column_is_nullable&&t.type_is_nullable,name:t.column_name,comment:t.column_comment??void 0}))}return Object.values(s)}async getMetadata(e){return{tables:await this.getTables(e)}}}const $i=/^[a-z0-9_]$/i;class Fi extends $t{getCurrentParameterPlaceholder(){return`@${this.numParameters}`}visitOffset(e){super.visitOffset(e),this.append(" rows")}compileColumnAlterations(e){const t={};for(const i of e)t[i.kind]||(t[i.kind]=[]),t[i.kind].push(i);let i=!0;t.AddColumnNode&&(this.append("add "),this.compileList(t.AddColumnNode),i=!1),t.AlterColumnNode&&(i||this.append(", "),this.compileList(t.AlterColumnNode)),t.DropColumnNode&&(i||this.append(", "),this.append("drop column "),this.compileList(t.DropColumnNode)),t.ModifyColumnNode&&(i||this.append(", "),this.compileList(t.ModifyColumnNode)),t.RenameColumnNode&&(i||this.append(", "),this.compileList(t.RenameColumnNode))}visitAddColumn(e){this.visitNode(e.column)}visitDropColumn(e){this.visitNode(e.column)}visitMergeQuery(e){super.visitMergeQuery(e),this.append(";")}visitCollate(e){this.append("collate ");const{name:t}=e.collation;for(const e of t)if(!$i.test(e))throw new Error(`Invalid collation: ${t}`);this.append(t)}announcesNewColumnDataType(){return!1}}class Vi{#M;constructor(e){this.#M=e}createDriver(){return new Qi(this.#M)}createQueryCompiler(){return new Fi}createAdapter(){return new Li}createIntrospector(e){return new Ui(e)}}class ji{#s;constructor(e){this.#s=e}async getMigrations(){const e={},t=await this.#s.fs.readdir(this.#s.migrationFolder);for(const i of t)if(i.endsWith(".js")||i.endsWith(".ts")&&!i.endsWith(".d.ts")||i.endsWith(".mjs")||i.endsWith(".mts")&&!i.endsWith(".d.mts")){const t=await import(this.#s.path.join(this.#s.migrationFolder,i)),s=i.substring(0,i.lastIndexOf("."));Ji(t?.default)?e[s]=t.default:Ji(t)&&(e[s]=t)}return e}}function Ji(e){return E(e)&&T(e.up)}class Ki extends u{#ke;constructor(e){super(),this.#ke=e}transformIdentifier(e,t){return e=super.transformIdentifier(e,t),{...e,name:this.#ke(e.name)}}}function zi(e){return e>="0"&&e<="9"}function Gi(e){const t=new Map;return i=>{let s=t.get(i);return s||(s=e(i),t.set(i,s)),s}}class Yi{opt;#Se;#ke;#Me;constructor(e={}){this.opt=e,this.#Se=function({upperCase:e=!1}={}){return Gi((t=>{if(0===t.length)return t;e&&function(e){for(let t=1,i=e.length;t<i;++t){const i=e[t];if("_"!==i&&i!==i.toUpperCase())return!1}return!0}(t)&&(t=t.toLowerCase());let i=t[0];for(let e=1,s=t.length;e<s;++e){const s=t[e],n=t[e-1];"_"!==s&&(i+="_"===n?s.toUpperCase():s)}return i}))}(e),this.#ke=function({upperCase:e=!1,underscoreBeforeDigits:t=!1,underscoreBetweenUppercaseLetters:i=!1}={}){return Gi((s=>{if(0===s.length)return s;const n=s.toUpperCase(),r=s.toLowerCase();let o=r[0];for(let e=1,a=s.length;e<a;++e){const a=s[e],p=s[e-1],c=n[e],d=n[e-1],h=r[e],l=r[e-1];!t||!zi(a)||zi(p)||o.endsWith("_")?o+=a===c&&c!==h?i||p!==d||d===l?"_"+h:h:a:o+="_"+a}return e?o.toUpperCase():o}))}(e),this.#Me=new Ki(this.snakeCase.bind(this))}transformQuery(e){return this.#Me.transformNode(e.node,e.queryId)}async transformResult(e){return e.result.rows&&Array.isArray(e.result.rows)?{...e.result,rows:e.result.rows.map((e=>this.mapRow(e)))}:e.result}mapRow(e){return Object.keys(e).reduce(((t,i)=>{let s=e[i];return Array.isArray(s)?s=s.map((e=>Hi(e,this.opt)?this.mapRow(e):e)):Hi(s,this.opt)&&(s=this.mapRow(s)),t[this.camelCase(i)]=s,t}),{})}snakeCase(e){return this.#ke(e)}camelCase(e){return this.#Se(e)}}function Hi(e,t){return Y(e)&&!t?.maintainNestedObjectKeys}class Xi extends u{transformSelectQuery(e,t){return this.#De(super.transformSelectQuery(e,t))}transformUpdateQuery(e,t){return this.#De(super.transformUpdateQuery(e,t))}transformDeleteQuery(e,t){return this.#De(super.transformDeleteQuery(e,t))}#De(t){return t.joins&&0!==t.joins.length?e({...t,joins:this.#Ae(t.joins)}):t}#Ae(t){const i=[];for(let e=0;e<t.length;++e){let s=!1;for(let n=0;n<i.length;++n)if(H(t[e],i[n])){s=!0;break}s||i.push(t[e])}return e(i)}}class Zi{#n=new Xi;transformQuery(e){return this.#n.transformNode(e.node,e.queryId)}transformResult(e){return Promise.resolve(e.result)}}class es{opt;#Le;constructor(e={}){this.opt=e,this.#Le=e.objectStrategy||"in-place"}transformQuery(e){return e.node}async transformResult(e){return{...e.result,rows:ts(e.result.rows,this.#Le)}}}function ts(e,t){const i="create"===t?new Array(e.length):e;for(let s=0;s<e.length;++s)i[s]=is(e[s],t);return i}function is(e,t){return q(e)?function(e){if(t=e,null!=t.match(/^[\[\{]/))try{return is(JSON.parse(e),"in-place")}catch(e){}var t;return e}(e):Array.isArray(e)?ts(e,t):Y(e)?function(e,t){const i="create"===t?{}:e;for(const s in e)i[s]=is(e[s],t);return i}(e,t):e}class ss extends u{#Pe;constructor(e){super(),this.#Pe=e}transformBinaryOperation(e){return this.#We(e)?this.#Pe(e):e}#We(e){const{operator:t,rightOperand:i}=e;return(X.is(i)||m.is(i))&&0===i.values.length&&R.is(t)&&("in"===t.operator||"not in"===t.operator)}}class ns{opt;#n;constructor(e){this.opt=e,this.#n=new ss(e.strategy)}transformQuery(e){return this.#n.transformNode(e.node,e.queryId)}async transformResult(e){return e.result}}let rs,os,ps,cs,ds,hs,ls;function us(e){const t=ps||=r.createImmediate(1),i=os||=R.create("=");return"in"===e.operator.operator?rs||=Z.create(t,i,r.createImmediate(0)):cs||=Z.create(t,i,t)}function ms(t){return function(i){return"in"===i.operator.operator?e({...i,rightOperand:hs||=m.create([r.createImmediate(null)])}):e({...i,leftOperand:ee.create(i.leftOperand,ds||=te.create("char")),rightOperand:ls||=m.create([r.createImmediate(t)])})}}export{he as AddColumnNode,Oe as AddConstraintNode,Qe as AddIndexNode,Me as AlterColumnBuilder,Se as AlterColumnNode,Ve as AlterTableBuilder,je as AlterTableColumnAlteringBuilder,ie as AlterTableNode,De as AlteredColumnBuilder,Z as BinaryOperationNode,Yi as CamelCasePlugin,O as CaseBuilder,I as CaseNode,ee as CastNode,ye as CheckConstraintNode,Ce as ColumnDefinitionBuilder,le as ColumnDefinitionNode,s as ColumnNode,qt as Command,Jt as CompiledQuery,At as ConnectionBuilder,Wt as ControlledTransaction,Pt as ControlledTransactionBuilder,Ke as CreateIndexBuilder,se as CreateIndexNode,ze as CreateSchemaBuilder,ne as CreateSchemaNode,Ye as CreateTableBuilder,oe as CreateTableNode,ot as CreateTypeBuilder,rt as CreateTypeNode,it as CreateViewBuilder,et as CreateViewNode,ri as DEFAULT_ALLOW_UNORDERED_MIGRATIONS,ni as DEFAULT_MIGRATION_LOCK_TABLE,si as DEFAULT_MIGRATION_TABLE,te as DataTypeNode,Zi as DeduplicateJoinsPlugin,wt as DefaultConnectionProvider,$t as DefaultQueryCompiler,ft as DefaultQueryExecutor,Ne as DefaultValueNode,Gt as DialectAdapterBase,ue as DropColumnNode,ke as DropConstraintNode,He as DropIndexBuilder,pe as DropIndexNode,Xe as DropSchemaBuilder,ce as DropSchemaNode,Ze as DropTableBuilder,de as DropTableNode,ct as DropTypeBuilder,pt as DropTypeNode,nt as DropViewBuilder,st as DropViewNode,Kt as DummyDriver,yt as DynamicModule,b as DynamicReferenceBuilder,x as DynamicTableBuilder,ji as FileMigrationProvider,_e as ForeignKeyConstraintBuilder,Ee as ForeignKeyConstraintNode,ve as GeneratedNode,ns as HandleEmptyInListsPlugin,t as IdentifierNode,L as InsertQueryNode,St as Kysely,_t as LOG_LEVELS,Ot as Log,oi as MIGRATION_LOCK_ID,ci as Migrator,Te as ModifyColumnNode,Li as MssqlAdapter,Vi as MssqlDialect,Qi as MssqlDriver,Ui as MssqlIntrospector,Fi as MssqlQueryCompiler,Ii as MysqlAdapter,ki as MysqlDialect,xi as MysqlDriver,_i as MysqlIntrospector,Ei as MysqlQueryCompiler,pi as NO_MIGRATIONS,re as ON_COMMIT_ACTIONS,we as ON_MODIFY_FOREIGN_ACTIONS,u as OperationNodeTransformer,Bt as OperationNodeVisitor,R as OperatorNode,A as ParensNode,es as ParseJSONResultsPlugin,gi as PostgresAdapter,Ai as PostgresDialect,Mi as PostgresDriver,wi as PostgresIntrospector,yi as PostgresQueryCompiler,qe as PrimaryConstraintNode,We as PrimaryKeyConstraintNode,X as PrimitiveValueListNode,_ as QueryCreator,y as QueryNode,d as RawNode,fe as ReferencesNode,ut as RefreshMaterializedViewBuilder,lt as RefreshMaterializedViewNode,me as RenameColumnNode,Fe as RenameConstraintNode,mt as SchemaModule,i as SchemableIdentifierNode,a as SelectAllNode,V as SelectQueryNode,P as SetOperationNode,xt as SingleConnectionProvider,li as SqliteAdapter,ui as SqliteDialect,Ht as SqliteDriver,hi as SqliteIntrospector,ti as SqliteQueryCompiler,Ct as TRANSACTION_ACCESS_MODES,Tt as TRANSACTION_ISOLATION_LEVELS,Mt as Transaction,Lt as TransactionBuilder,Ie as UniqueConstraintNode,m as ValueListNode,r as ValueNode,W as WhenNode,N as WithSchemaPlugin,S as createFunctionModule,v as createQueryId,kt as isCompilable,Dt as isKyselyProps,n as isOperationNodeSource,M as logOnce,ms as pushValueIntoList,us as replaceWithNoncontingentExpression,J as sql,Et as validateTransactionSettings};
